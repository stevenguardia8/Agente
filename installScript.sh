#!/bin/bash

# Check before locking $0, as the first user has exclusive lock privileges
if [[ $EUID -ne 0 ]]; then
  echo "This script must be run as root (use sudo or su)"
  exit 1
fi
# try to acquire exclusive lock, if failed exit with code 254
[ "${SBA_FLOCKER}" != "$0" ] && exec env SBA_FLOCKER="$0" flock -E 254 -en "/tmp/sbalinux-install.lock" "$0" "$@" || :

set -euo pipefail

[[ ! -z ${SBA_INSTALLER_DEBUG:=""} ]] && set -x

# force english localization for package manager
export LANGUAGE=en_US:en

# script version placeholder should be replaced by CI pipeline
SCRIPT_VER='1.10.5'

# offline package metadata
PACKAGE_DISPLAY_NAME="__CP_PACKAGE_NAME__"
PACKAGE_ID="__CP_PACKAGE_ID__"
PACKAGE_DISTRO="__CP_PACKAGE_DISTRO__"
PACKAGE_FEATURES="__CP_PACKAGE_BLADE_MASK__"
PACKAGE_PLATFORM="__CP_PACKAGE_PLATFORM__"

# embedded arguments to be filled by the management server providing the script, __CP_*__ place holders should be replaced with valid values
# >>REPLACE START
EMBEDDED_MGMT_FQDN='DUNOSU-de941bc0-hap1.epmgmt.checkpoint.com'
EMBEDDED_MGMT_KEY='__CP_MGMT_KEY__'
EMBEDDED_MGMT_CA_CERT='LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUdyRENDQlpTZ0F3SUJBZ0lKQU51VHd1SGF1UDRFTUEwR0NTcUdTSWIzRFFFQkN3VUFNSUcwTVFzd0NRWUQKVlFRR0V3SlZVekVRTUE0R0ExVUVDQk1IUVhKcGVtOXVZVEVUTUJFR0ExVUVCeE1LVTJOdmRIUnpaR0ZzWlRFYQpNQmdHQTFVRUNoTVJSMjlFWVdSa2VTNWpiMjBzSUVsdVl5NHhMVEFyQmdOVkJBc1RKR2gwZEhBNkx5OWpaWEowCmN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpFek1ERUdBMVVFQXhNcVIyOGdSR0ZrWkhrZ1UyVmoKZFhKbElFTmxjblJwWm1sallYUmxJRUYxZEdodmNtbDBlU0F0SUVjeU1CNFhEVEl4TURreE9UQTNNVFV5TTFvWApEVEl5TVRBeU1UQTNNVFV5TTFvd0lqRWdNQjRHQTFVRUF3d1hLaTVsY0cxbmJYUXVZMmhsWTJ0d2IybHVkQzVqCmIyMHdnZ0VpTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFEQ0h0TTgzSEp4NUk0ZEFHVGoKWlFlOXIzK1JVQTkvSEZiMzMvWmtqQ0lTTjNibFJCZU5xOCtTL1VRaENQNXpNdHFxdElOTGpIb213UFZWV3NzSQpxZzZmOEFJMGZnY0c4WjlyMDllRVlCcHQ4a3Q2bm0vMmEveHNCUnptNmZDYTFNL3FWOWdHV2FBUmZ3N2tRMEkvCjJtemdYRmJwWFVJd1VyOWNWZ2VEZStDc3Q3dVdPQmJmVm1MRVRKUmVML3psUzlmME11c0VpR2RNQWVGMVp3NGwKNWRtY2ZydnNZUzRJSU8rNVVEU0c2b1ExTjNGNnk1TUxiUUppRmNRUks4NGNUTW9ud2pVVWVqbDQ2WFpjL21HZwpERTlnT2p4SFBWa0s3YnliZjdGUDc2cU0zK1JzMG5ueGFhMVVhSU5MOGI0bTQrUUZpcGpNSlRDVkpOTHNxYlpOCm9BM3JBZ01CQUFHamdnTlFNSUlEVERBTUJnTlZIUk1CQWY4RUFqQUFNQjBHQTFVZEpRUVdNQlFHQ0NzR0FRVUYKQndNQkJnZ3JCZ0VGQlFjREFqQU9CZ05WSFE4QkFmOEVCQU1DQmFBd09BWURWUjBmQkRFd0x6QXRvQ3VnS1lZbgphSFIwY0RvdkwyTnliQzVuYjJSaFpHUjVMbU52YlM5blpHbG5Nbk14TFRNek1EUXVZM0pzTUYwR0ExVWRJQVJXCk1GUXdTQVlMWUlaSUFZYjliUUVIRndFd09UQTNCZ2dyQmdFRkJRY0NBUllyYUhSMGNEb3ZMMk5sY25ScFptbGoKWVhSbGN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpBSUJnWm5nUXdCQWdFd2RnWUlLd1lCQlFVSApBUUVFYWpCb01DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHZiMk56Y0M1bmIyUmhaR1I1TG1OdmJTOHdRQVlJCkt3WUJCUVVITUFLR05HaDBkSEE2THk5alpYSjBhV1pwWTJGMFpYTXVaMjlrWVdSa2VTNWpiMjB2Y21Wd2IzTnAKZEc5eWVTOW5aR2xuTWk1amNuUXdId1lEVlIwakJCZ3dGb0FVUU1LOUo0N01OSU13b2pQWCsyeXo4TFFzZ000dwpPUVlEVlIwUkJESXdNSUlYS2k1bGNHMW5iWFF1WTJobFkydHdiMmx1ZEM1amIyMkNGV1Z3YldkdGRDNWphR1ZqCmEzQnZhVzUwTG1OdmJUQWRCZ05WSFE0RUZnUVV0TUpteVdDWmdWeXAvZG9kaWszUGRjNUs4SGN3Z2dGL0Jnb3IKQmdFRUFkWjVBZ1FDQklJQmJ3U0NBV3NCYVFCMkFDbDV2dkNlT1RraDhGWnpuMk9sZCtXK1YzMmNZQXI0K1UxZApKbHdsWGNlRUFBQUJlL3pwMENjQUFBUURBRWN3UlFJZ0ZOd0djWG5rQ2ZiZXNldTRGb2lqSXZFRnY2YXlKczFsCnUzM1RNbG8zemVvQ0lRRHd4M1I3Tk9ib1A1dXBoTy94L242RjlWTXRBZUNlU1BmQ3JZeDVrektsWXdCMkFOK2wKWHF0b2drOGZiSzN1dUY5T1BscnF6YUlTcEdwZWpqc1N3Q0JFWENwekFBQUJlL3pwMGtzQUFBUURBRWN3UlFJZwpWZitHRVdGUGtJdjhIanZOYkZ0WU0zNFdDVHZHaHNhbGt3V3BmT2JNTE4wQ0lRQ0RaR1dNa2I0QTBUUkhXbXMrCkEzNGtkSlhqUTgzVlRTS09zUWsweXNGYmN3QjNBRUhJeXJIZklrWktFTWFoT2dsQ2gxNU9NWXNiQSt2clM4ZG8KOEpCaWxnYjJBQUFCZS96cDBzOEFBQVFEQUVnd1JnSWhBT2IvNklWZm5lVHBsSlNSVEQ4b2krTXhCdFNFT1BXNgpmd0l4WGZ4Kyt2cUNBaUVBdzVSeFJkOTBkUUpmU2l2azhSVjZiUDVuWUM4UzlWdFNyYlNYVG5KRFBCa3dEUVlKCktvWklodmNOQVFFTEJRQURnZ0VCQUhIUXhGdlU1SENwNERwS2tGQ2xBbGxRQ1NQWmtNc04rL3BVemVlbHFUNG0KcjJxUTI5Y056a1dkV3poTnZHeFVFQWMvWnRtVDZCWjdBUG9YRURiczdXODlRWURra3RndW9zQmhtS2FKMXJjMgpTMFNUQk43NXh3SFc0ZjZxYy94Q1VxbU5BNU0yNTRYQVZMWGFtZDlSQXVIQjQrL25YbnVtN2YzS3pSdHJyN3pyCnlCdWtmQU9OMHFpMXJEMStsdGtxT3JRWDhUcDFhZWZHMmJFZHpjQm05S3J4UW5nWWxCTTNabFhBRkNocDNxR1cKRnJSVVBGbWZZcFRra2hYYVpmQ05vMFBDdDNHWGpaL2R0aVkrMXVhMVc4SlYwMnN6d3Fkbk5aQVFldmtaV1YwdwoyRW85Y1R0Zzk2TjZ1NmR5SWRwR0ZvbmdhM0kwWHpyM1pOdnBuZDlNc0tNPQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFMERDQ0E3aWdBd0lCQWdJQkJ6QU5CZ2txaGtpRzl3MEJBUXNGQURDQmd6RUxNQWtHQTFVRUJoTUNWVk14CkVEQU9CZ05WQkFnVEIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1QKRVVkdlJHRmtaSGt1WTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScApabWxqWVhSbElFRjFkR2h2Y21sMGVTQXRJRWN5TUI0WERURXhNRFV3TXpBM01EQXdNRm9YRFRNeE1EVXdNekEzCk1EQXdNRm93Z2JReEN6QUpCZ05WQkFZVEFsVlRNUkF3RGdZRFZRUUlFd2RCY21sNmIyNWhNUk13RVFZRFZRUUgKRXdwVFkyOTBkSE5rWVd4bE1Sb3dHQVlEVlFRS0V4RkhiMFJoWkdSNUxtTnZiU3dnU1c1akxqRXRNQ3NHQTFVRQpDeE1rYUhSMGNEb3ZMMk5sY25SekxtZHZaR0ZrWkhrdVkyOXRMM0psY0c5emFYUnZjbmt2TVRNd01RWURWUVFECkV5cEhieUJFWVdSa2VTQlRaV04xY21VZ1EyVnlkR2xtYVdOaGRHVWdRWFYwYUc5eWFYUjVJQzBnUnpJd2dnRWkKTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNTRNc1ExSzkydmRTVFl1c3daTGlCQ0d6RApCTmxpRjQ0di96NWx6NC9PWXVZOFVoemFGa1ZMVmF0NGEyT0RZcERPRDJsc21jZ2FGSXRNekVVejZvamNucU92CksvNkFZWjE1VjhUUEx2US9NRHhkUi95YUZyekRONVpCVVk0UlMxVDRLTDdRakw3d01EZ2U4N0FtK0daSFkyM2UKY1NaSGp6aEhVOUZHSGJUajNBRHFSYXk5dkhIWnFtOEEyOXZOTURwNVQxOU1SL2dkNzF2Q3hKMWdPN0d5UTVIWQpwRE5PNnJQV0owK3RKWXFseHZUVjBLYXVkQVZrVjRpMVJGWFVMU282UHZpNHZla3lDZ0tVWk1RV09sRHhTcTduCmVUT3ZEQ0FIZitqZkJEbkNhUUpzWTFMNmQ4RWJ5SFNIeUxtVEdGQlVOVXRwVHJ3NzAwa3VIOXpCMGxMN0FnTUIKQUFHamdnRWFNSUlCRmpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUE0R0ExVWREd0VCL3dRRUF3SUJCakFkQmdOVgpIUTRFRmdRVVFNSzlKNDdNTklNd29qUFgrMnl6OExRc2dNNHdId1lEVlIwakJCZ3dGb0FVT3BxRkJ4Qm5LTGJ2CjlyMEZRVzRnd1pUYUQ5NHdOQVlJS3dZQkJRVUhBUUVFS0RBbU1DUUdDQ3NHQVFVRkJ6QUJoaGhvZEhSd09pOHYKYjJOemNDNW5iMlJoWkdSNUxtTnZiUzh3TlFZRFZSMGZCQzR3TERBcW9DaWdKb1lrYUhSMGNEb3ZMMk55YkM1bgpiMlJoWkdSNUxtTnZiUzluWkhKdmIzUXRaekl1WTNKc01FWUdBMVVkSUFRL01EMHdPd1lFVlIwZ0FEQXpNREVHCkNDc0dBUVVGQndJQkZpVm9kSFJ3Y3pvdkwyTmxjblJ6TG1kdlpHRmtaSGt1WTI5dEwzSmxjRzl6YVhSdmNua3YKTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBSWZteVRFTWc0dUphcGtFdi9vVjlQQk85c1BweUlCc2xRajZaego5MWN4Rzc2ODVDL2IrTHJUVytDMDUrWjVZZzRNb3RkcVkzTXh0ZldvU0tRN0NDMmlYWkRYdEh3bFR4RldNTVMyClJKMTdMSjNsWHVidkRHR3F2K1FxRys2RW5yaURmY0ZEemtTbkUzQU5rUi8weUJPdGcyRFoySEtvY3lRZXRhd2kKRHNvWGlXSllSQnVyaVNVQkFBL054QnRpMjFHMDB3OVJLcHYwdkhQOGRzNDJwTTNaMkN6cXJwdjFLcktRMFUxMQpHSW8vaWtHUUkzMWJTLzZrQTFpYlJyTERZR0NEK0gxUVFjN0NvWkREdSs4Q0w5SVZWTzVFRmRrS3JxZUtNKzJ4CkxYWTJKdHdFNjUvM1lSOFYzSWR2N2thV0tLMmhKbjBLQ2FjdUJLT052UGk4QkRBQgotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQpNSUlFZlRDQ0EyV2dBd0lCQWdJREcrY1ZNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1HTXhDekFKQmdOVkJBWVRBbFZUCk1TRXdId1lEVlFRS0V4aFVhR1VnUjI4Z1JHRmtaSGtnUjNKdmRYQXNJRWx1WXk0eE1UQXZCZ05WQkFzVEtFZHYKSUVSaFpHUjVJRU5zWVhOeklESWdRMlZ5ZEdsbWFXTmhkR2x2YmlCQmRYUm9iM0pwZEhrd0hoY05NVFF3TVRBeApNRGN3TURBd1doY05NekV3TlRNd01EY3dNREF3V2pDQmd6RUxNQWtHQTFVRUJoTUNWVk14RURBT0JnTlZCQWdUCkIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1RFVWR2UkdGa1pIa3UKWTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScFptbGpZWFJsSUVGMQpkR2h2Y21sMGVTQXRJRWN5TUlJQklqQU5CZ2txaGtpRzl3MEJBUUVGQUFPQ0FROEFNSUlCQ2dLQ0FRRUF2M0ZpCkNQSDZXVFQzRzhrWW8vZUFTVmpwSW9NVHBzVWdRd0U3aFBIbWhVbWZKK3IyaEJ0T29MVGJjSmpITWdHeEJUNEgKVHU3MCtrOHZXVEFpNTZzWlZtdmlnQWY4OHhaMWdEbFJlK1g1TmJaMFRxbU5naFBrdGorcEE0UDZvcjZLRldwLwozZ3ZEdGhrVUJjcnF3NmdFbER0R2ZESU44d0JtSXNpTmFXMDJqQkVZdDlPeUhHQzBPUG9Dak03VDNVWUgzZ28rCjYxMTh5SHo3c0N0VHBKSmlhVkVsQldFYVJJR01MS2xEbGlQZnJEcUJtZzRweFJ5cDZWMGV0cDZlTUFvNXp2R0kKZ1B0TFhjd3k3SVZpUXlVMEFsWW5BWkcwTzNBcVAyNng2SnlJQVgyZjFQbmJVMjFnbmI4czUxaXJ1RjlHL003RQpHd004Q2V0Sk1WeHBSclBnUndJREFRQUJvNElCRnpDQ0FSTXdEd1lEVlIwVEFRSC9CQVV3QXdFQi96QU9CZ05WCkhROEJBZjhFQkFNQ0FRWXdIUVlEVlIwT0JCWUVGRHFhaFFjUVp5aTI3L2E5QlVGdUlNR1UyZy9lTUI4R0ExVWQKSXdRWU1CYUFGTkxFc05LUjFFd1JjYk5oeXoyaC90Mm9hdFRqTURRR0NDc0dBUVVGQndFQkJDZ3dKakFrQmdncgpCZ0VGQlFjd0FZWVlhSFIwY0RvdkwyOWpjM0F1WjI5a1lXUmtlUzVqYjIwdk1ESUdBMVVkSHdRck1Da3dKNkFsCm9DT0dJV2gwZEhBNkx5OWpjbXd1WjI5a1lXUmtlUzVqYjIwdloyUnliMjkwTG1OeWJEQkdCZ05WSFNBRVB6QTkKTURzR0JGVWRJQUF3TXpBeEJnZ3JCZ0VGQlFjQ0FSWWxhSFIwY0hNNkx5OWpaWEowY3k1bmIyUmhaR1I1TG1OdgpiUzl5WlhCdmMybDBiM0o1THpBTkJna3Foa2lHOXcwQkFRc0ZBQU9DQVFFQVdRdFR2WktHRWFja2UrMWJNYzhkCkgyeHd4Ymh1dms2NzlyNlhVT0V3Zjdvb1hHS1V3dU4rTS9mN1FuYUYyNVVjakNKWWRRa01pR1ZuT1FvV0NjV2cKT0pla3hTT1RQN1FZcGdFR1JKSGpwMmtudEZvbGZ6cTNNczNkaFA4cU9Da3pwTjFuc29YK29ZZ2dIRkNKeU53cQo5a0lETjB6bWlOL1ZyeVR5c2NQZnpMWHM0SmxldDBsVUlEeVVHQXpISEZJWVNhUnQ0Yk5ZQzhuWTdObXVIREtPCktIQU40djZtRjU2RUQ3MVhjTE5hNlIrZ2hsTzc3M3ovYVF2Z1NNTzNrd3ZJQ2xURXJGMFVaemRzeXFVdk1RZzMKcW01dmpMeWI0bGRkSklHdmw1ZWNoSzFzckRkTVp2TmhrUkVnNUw0d24zcWtLUW13NFRSZlpIY1lRRkhmakRDbQpydz09Ci0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0KLS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUVBRENDQXVpZ0F3SUJBZ0lCQURBTkJna3Foa2lHOXcwQkFRVUZBREJqTVFzd0NRWURWUVFHRXdKVlV6RWgKTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNUlFZHliM1Z3TENCSmJtTXVNVEV3THdZRFZRUUxFeWhIYnlCRQpZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqWVhScGIyNGdRWFYwYUc5eWFYUjVNQjRYRFRBME1EWXlPVEUzCk1EWXlNRm9YRFRNME1EWXlPVEUzTURZeU1Gb3dZekVMTUFrR0ExVUVCaE1DVlZNeElUQWZCZ05WQkFvVEdGUm8KWlNCSGJ5QkVZV1JrZVNCSGNtOTFjQ3dnU1c1akxqRXhNQzhHQTFVRUN4TW9SMjhnUkdGa1pIa2dRMnhoYzNNZwpNaUJEWlhKMGFXWnBZMkYwYVc5dUlFRjFkR2h2Y21sMGVUQ0NBU0F3RFFZSktvWklodmNOQVFFQkJRQURnZ0VOCkFEQ0NBUWdDZ2dFQkFONmQxK3BYR0VtaFcrdlhYMGlHNnI3ZC8rVHZaeHowWldpelYzR2dYbmU3N1p0SjZYQ0EKUFZZWVl3aHYydkxNMEQ5L0FsUWlWQkRZc29IVXdIVTlTMy9IZDhNK2VLc2FBN1VnYXk5cUs3SEZpSDdFdXg2dwp3ZGhGSjIrcU4xajNoeWJYMkMzMnFSZTNIM0kyVHFZWFAyV1lrdHNxYmwyaS9vamdDOTUvNVkwVjRldkxPdFhpCkVxSVRMZGlPcjE4U1BhQUlCUWkyWEtWbE9BUkZtUjZqWUdCMHhVR2xjbUliWXNVZmIxOGFRcjRDVVdXb3JpTVkKYXZ4NEE2bE5mNEREK3F0YS9LRkFwTW9aRnY2eXlPOWVjdzN1ZDcyYTlubVl2TEVIWjZJVkRkMmdXTVpFZXdvKwpZaWhmdWtFSFUxalBFWDQ0ZE1YNC83VnBrSStFZE9xWEc2OENBUU9qZ2NBd2diMHdIUVlEVlIwT0JCWUVGTkxFCnNOS1IxRXdSY2JOaHl6MmgvdDJvYXRUak1JR05CZ05WSFNNRWdZVXdnWUtBRk5MRXNOS1IxRXdSY2JOaHl6MmgKL3Qyb2F0VGpvV2VrWlRCak1Rc3dDUVlEVlFRR0V3SlZVekVoTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNQpJRWR5YjNWd0xDQkpibU11TVRFd0x3WURWUVFMRXloSGJ5QkVZV1JrZVNCRGJHRnpjeUF5SUVObGNuUnBabWxqCllYUnBiMjRnUVhWMGFHOXlhWFI1Z2dFQU1Bd0dBMVVkRXdRRk1BTUJBZjh3RFFZSktvWklodmNOQVFFRkJRQUQKZ2dFQkFESkw4N0xLUHBIOEVzYWhCNHlPZDZBekJoUmNrQjRZOXdpbVBRb1orWWVBRVc1cDVKWVhNUDgwa1dOeQpPTzdNSEFHakhaUW9wREgyZXNSVTEvYmxNVmdEb3N6T1l0dVVSWE8xdjBYSkpMWFZnZ0t0STNscGpiaTJUYzdQClRNb3pJK2djaUtxZGkwRnVGc2tnNVltZXpUdmFjUGQrbVNZZ0ZGUWxxMjV6aGVhYklaMEtiSUlPcVBqQ0RQb1EKSG15Vzc0Y054QTloaTYzdWd5dVYrSTZTaEhJNTZ5RHFnKzJEelpkdUNMenJUaWEyY3l2azAvWk0vaVp4NG1FUgpkRXIvVnhxSEQzVklMczlSYVJlZ0FoSmhsZFhSUUxJUVRPN0VyQkJEcHFXZUN0V1ZZcG9OejRpQ3hUSU01Q3VmClJlWU5ueWljc2JrcVdsZXROdyt2SFgvYnZaOD0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQo='
EMBEDDED_MGMT_CA_CERT_SIG='MIIgQwYJKoZIhvcNAQcCoIIgNDCCIDACAQExDTALBglghkgBZQMEAgEwghyJBgkqhkiG9w0BBwGgghx6BIIcdi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQ0KTUlJR3JEQ0NCWlNnQXdJQkFnSUpBTnVUd3VIYXVQNEVNQTBHQ1NxR1NJYjNEUUVCQ3dVQU1JRzBNUXN3Q1FZRA0KVlFRR0V3SlZVekVRTUE0R0ExVUVDQk1IUVhKcGVtOXVZVEVUTUJFR0ExVUVCeE1LVTJOdmRIUnpaR0ZzWlRFYQ0KTUJnR0ExVUVDaE1SUjI5RVlXUmtlUzVqYjIwc0lFbHVZeTR4TFRBckJnTlZCQXNUSkdoMGRIQTZMeTlqWlhKMA0KY3k1bmIyUmhaR1I1TG1OdmJTOXlaWEJ2YzJsMGIzSjVMekV6TURFR0ExVUVBeE1xUjI4Z1JHRmtaSGtnVTJWag0KZFhKbElFTmxjblJwWm1sallYUmxJRUYxZEdodmNtbDBlU0F0SUVjeU1CNFhEVEl4TURreE9UQTNNVFV5TTFvWA0KRFRJeU1UQXlNVEEzTVRVeU0xb3dJakVnTUI0R0ExVUVBd3dYS2k1bGNHMW5iWFF1WTJobFkydHdiMmx1ZEM1ag0KYjIwd2dnRWlNQTBHQ1NxR1NJYjNEUUVCQVFVQUE0SUJEd0F3Z2dFS0FvSUJBUURDSHRNODNISng1STRkQUdUag0KWlFlOXIzK1JVQTkvSEZiMzMvWmtqQ0lTTjNibFJCZU5xOCtTL1VRaENQNXpNdHFxdElOTGpIb213UFZWV3NzSQ0KcWc2ZjhBSTBmZ2NHOFo5cjA5ZUVZQnB0OGt0Nm5tLzJhL3hzQlJ6bTZmQ2ExTS9xVjlnR1dhQVJmdzdrUTBJLw0KMm16Z1hGYnBYVUl3VXI5Y1ZnZURlK0NzdDd1V09CYmZWbUxFVEpSZUwvemxTOWYwTXVzRWlHZE1BZUYxWnc0bA0KNWRtY2ZydnNZUzRJSU8rNVVEU0c2b1ExTjNGNnk1TUxiUUppRmNRUks4NGNUTW9ud2pVVWVqbDQ2WFpjL21HZw0KREU5Z09qeEhQVmtLN2J5YmY3RlA3NnFNMytSczBubnhhYTFVYUlOTDhiNG00K1FGaXBqTUpUQ1ZKTkxzcWJaTg0Kb0EzckFnTUJBQUdqZ2dOUU1JSURUREFNQmdOVkhSTUJBZjhFQWpBQU1CMEdBMVVkSlFRV01CUUdDQ3NHQVFVRg0KQndNQkJnZ3JCZ0VGQlFjREFqQU9CZ05WSFE4QkFmOEVCQU1DQmFBd09BWURWUjBmQkRFd0x6QXRvQ3VnS1lZbg0KYUhSMGNEb3ZMMk55YkM1bmIyUmhaR1I1TG1OdmJTOW5aR2xuTW5NeExUTXpNRFF1WTNKc01GMEdBMVVkSUFSVw0KTUZRd1NBWUxZSVpJQVliOWJRRUhGd0V3T1RBM0JnZ3JCZ0VGQlFjQ0FSWXJhSFIwY0RvdkwyTmxjblJwWm1sag0KWVhSbGN5NW5iMlJoWkdSNUxtTnZiUzl5WlhCdmMybDBiM0o1THpBSUJnWm5nUXdCQWdFd2RnWUlLd1lCQlFVSA0KQVFFRWFqQm9NQ1FHQ0NzR0FRVUZCekFCaGhob2RIUndPaTh2YjJOemNDNW5iMlJoWkdSNUxtTnZiUzh3UUFZSQ0KS3dZQkJRVUhNQUtHTkdoMGRIQTZMeTlqWlhKMGFXWnBZMkYwWlhNdVoyOWtZV1JrZVM1amIyMHZjbVZ3YjNOcA0KZEc5eWVTOW5aR2xuTWk1amNuUXdId1lEVlIwakJCZ3dGb0FVUU1LOUo0N01OSU13b2pQWCsyeXo4TFFzZ000dw0KT1FZRFZSMFJCREl3TUlJWEtpNWxjRzFuYlhRdVkyaGxZMnR3YjJsdWRDNWpiMjJDRldWd2JXZHRkQzVqYUdWag0KYTNCdmFXNTBMbU52YlRBZEJnTlZIUTRFRmdRVXRNSm15V0NaZ1Z5cC9kb2RpazNQZGM1SzhIY3dnZ0YvQmdvcg0KQmdFRUFkWjVBZ1FDQklJQmJ3U0NBV3NCYVFCMkFDbDV2dkNlT1RraDhGWnpuMk9sZCtXK1YzMmNZQXI0K1UxZA0KSmx3bFhjZUVBQUFCZS96cDBDY0FBQVFEQUVjd1JRSWdGTndHY1hua0NmYmVzZXU0Rm9pakl2RUZ2NmF5SnMxbA0KdTMzVE1sbzN6ZW9DSVFEd3gzUjdOT2JvUDV1cGhPL3gvbjZGOVZNdEFlQ2VTUGZDcll4NWt6S2xZd0IyQU4rbA0KWHF0b2drOGZiSzN1dUY5T1BscnF6YUlTcEdwZWpqc1N3Q0JFWENwekFBQUJlL3pwMGtzQUFBUURBRWN3UlFJZw0KVmYrR0VXRlBrSXY4SGp2TmJGdFlNMzRXQ1R2R2hzYWxrd1dwZk9iTUxOMENJUUNEWkdXTWtiNEEwVFJIV21zKw0KQTM0a2RKWGpRODNWVFNLT3NRazB5c0ZiY3dCM0FFSEl5ckhmSWtaS0VNYWhPZ2xDaDE1T01Zc2JBK3ZyUzhkbw0KOEpCaWxnYjJBQUFCZS96cDBzOEFBQVFEQUVnd1JnSWhBT2IvNklWZm5lVHBsSlNSVEQ4b2krTXhCdFNFT1BXNg0KZndJeFhmeCsrdnFDQWlFQXc1UnhSZDkwZFFKZlNpdms4UlY2YlA1bllDOFM5VnRTcmJTWFRuSkRQQmt3RFFZSg0KS29aSWh2Y05BUUVMQlFBRGdnRUJBSEhReEZ2VTVIQ3A0RHBLa0ZDbEFsbFFDU1Baa01zTisvcFV6ZWVscVQ0bQ0KcjJxUTI5Y056a1dkV3poTnZHeFVFQWMvWnRtVDZCWjdBUG9YRURiczdXODlRWURra3RndW9zQmhtS2FKMXJjMg0KUzBTVEJONzV4d0hXNGY2cWMveENVcW1OQTVNMjU0WEFWTFhhbWQ5UkF1SEI0Ky9uWG51bTdmM0t6UnRycjd6cg0KeUJ1a2ZBT04wcWkxckQxK2x0a3FPclFYOFRwMWFlZkcyYkVkemNCbTlLcnhRbmdZbEJNM1psWEFGQ2hwM3FHVw0KRnJSVVBGbWZZcFRra2hYYVpmQ05vMFBDdDNHWGpaL2R0aVkrMXVhMVc4SlYwMnN6d3Fkbk5aQVFldmtaV1Ywdw0KMkVvOWNUdGc5Nk42dTZkeUlkcEdGb25nYTNJMFh6cjNaTnZwbmQ5TXNLTT0NCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0NCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQ0KTUlJRTBEQ0NBN2lnQXdJQkFnSUJCekFOQmdrcWhraUc5dzBCQVFzRkFEQ0JnekVMTUFrR0ExVUVCaE1DVlZNeA0KRURBT0JnTlZCQWdUQjBGeWFYcHZibUV4RXpBUkJnTlZCQWNUQ2xOamIzUjBjMlJoYkdVeEdqQVlCZ05WQkFvVA0KRVVkdlJHRmtaSGt1WTI5dExDQkpibU11TVRFd0x3WURWUVFERXloSGJ5QkVZV1JrZVNCU2IyOTBJRU5sY25ScA0KWm1sallYUmxJRUYxZEdodmNtbDBlU0F0SUVjeU1CNFhEVEV4TURVd016QTNNREF3TUZvWERUTXhNRFV3TXpBMw0KTURBd01Gb3dnYlF4Q3pBSkJnTlZCQVlUQWxWVE1SQXdEZ1lEVlFRSUV3ZEJjbWw2YjI1aE1STXdFUVlEVlFRSA0KRXdwVFkyOTBkSE5rWVd4bE1Sb3dHQVlEVlFRS0V4RkhiMFJoWkdSNUxtTnZiU3dnU1c1akxqRXRNQ3NHQTFVRQ0KQ3hNa2FIUjBjRG92TDJObGNuUnpMbWR2WkdGa1pIa3VZMjl0TDNKbGNHOXphWFJ2Y25rdk1UTXdNUVlEVlFRRA0KRXlwSGJ5QkVZV1JrZVNCVFpXTjFjbVVnUTJWeWRHbG1hV05oZEdVZ1FYVjBhRzl5YVhSNUlDMGdSekl3Z2dFaQ0KTUEwR0NTcUdTSWIzRFFFQkFRVUFBNElCRHdBd2dnRUtBb0lCQVFDNTRNc1ExSzkydmRTVFl1c3daTGlCQ0d6RA0KQk5saUY0NHYvejVsejQvT1l1WThVaHphRmtWTFZhdDRhMk9EWXBET0QybHNtY2dhRkl0TXpFVXo2b2pjbnFPdg0KSy82QVlaMTVWOFRQTHZRL01EeGRSL3lhRnJ6RE41WkJVWTRSUzFUNEtMN1FqTDd3TURnZTg3QW0rR1pIWTIzZQ0KY1NaSGp6aEhVOUZHSGJUajNBRHFSYXk5dkhIWnFtOEEyOXZOTURwNVQxOU1SL2dkNzF2Q3hKMWdPN0d5UTVIWQ0KcEROTzZyUFdKMCt0SllxbHh2VFYwS2F1ZEFWa1Y0aTFSRlhVTFNvNlB2aTR2ZWt5Q2dLVVpNUVdPbER4U3E3bg0KZVRPdkRDQUhmK2pmQkRuQ2FRSnNZMUw2ZDhFYnlIU0h5TG1UR0ZCVU5VdHBUcnc3MDBrdUg5ekIwbEw3QWdNQg0KQUFHamdnRWFNSUlCRmpBUEJnTlZIUk1CQWY4RUJUQURBUUgvTUE0R0ExVWREd0VCL3dRRUF3SUJCakFkQmdOVg0KSFE0RUZnUVVRTUs5SjQ3TU5JTXdvalBYKzJ5ejhMUXNnTTR3SHdZRFZSMGpCQmd3Rm9BVU9wcUZCeEJuS0xidg0KOXIwRlFXNGd3WlRhRDk0d05BWUlLd1lCQlFVSEFRRUVLREFtTUNRR0NDc0dBUVVGQnpBQmhoaG9kSFJ3T2k4dg0KYjJOemNDNW5iMlJoWkdSNUxtTnZiUzh3TlFZRFZSMGZCQzR3TERBcW9DaWdKb1lrYUhSMGNEb3ZMMk55YkM1bg0KYjJSaFpHUjVMbU52YlM5blpISnZiM1F0WnpJdVkzSnNNRVlHQTFVZElBUS9NRDB3T3dZRVZSMGdBREF6TURFRw0KQ0NzR0FRVUZCd0lCRmlWb2RIUndjem92TDJObGNuUnpMbWR2WkdGa1pIa3VZMjl0TDNKbGNHOXphWFJ2Y25rdg0KTUEwR0NTcUdTSWIzRFFFQkN3VUFBNElCQVFBSWZteVRFTWc0dUphcGtFdi9vVjlQQk85c1BweUlCc2xRajZaeg0KOTFjeEc3Njg1Qy9iK0xyVFcrQzA1K1o1WWc0TW90ZHFZM014dGZXb1NLUTdDQzJpWFpEWHRId2xUeEZXTU1TMg0KUkoxN0xKM2xYdWJ2REdHcXYrUXFHKzZFbnJpRGZjRkR6a1NuRTNBTmtSLzB5Qk90ZzJEWjJIS29jeVFldGF3aQ0KRHNvWGlXSllSQnVyaVNVQkFBL054QnRpMjFHMDB3OVJLcHYwdkhQOGRzNDJwTTNaMkN6cXJwdjFLcktRMFUxMQ0KR0lvL2lrR1FJMzFiUy82a0ExaWJSckxEWUdDRCtIMVFRYzdDb1pERHUrOENMOUlWVk81RUZka0tycWVLTSsyeA0KTFhZMkp0d0U2NS8zWVI4VjNJZHY3a2FXS0syaEpuMEtDYWN1QktPTnZQaThCREFCDQotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tDQotLS0tLUJFR0lOIENFUlRJRklDQVRFLS0tLS0NCk1JSUVmVENDQTJXZ0F3SUJBZ0lERytjVk1BMEdDU3FHU0liM0RRRUJDd1VBTUdNeEN6QUpCZ05WQkFZVEFsVlQNCk1TRXdId1lEVlFRS0V4aFVhR1VnUjI4Z1JHRmtaSGtnUjNKdmRYQXNJRWx1WXk0eE1UQXZCZ05WQkFzVEtFZHYNCklFUmhaR1I1SUVOc1lYTnpJRElnUTJWeWRHbG1hV05oZEdsdmJpQkJkWFJvYjNKcGRIa3dIaGNOTVRRd01UQXgNCk1EY3dNREF3V2hjTk16RXdOVE13TURjd01EQXdXakNCZ3pFTE1Ba0dBMVVFQmhNQ1ZWTXhFREFPQmdOVkJBZ1QNCkIwRnlhWHB2Ym1FeEV6QVJCZ05WQkFjVENsTmpiM1IwYzJSaGJHVXhHakFZQmdOVkJBb1RFVWR2UkdGa1pIa3UNClkyOXRMQ0JKYm1NdU1URXdMd1lEVlFRREV5aEhieUJFWVdSa2VTQlNiMjkwSUVObGNuUnBabWxqWVhSbElFRjENCmRHaHZjbWwwZVNBdElFY3lNSUlCSWpBTkJna3Foa2lHOXcwQkFRRUZBQU9DQVE4QU1JSUJDZ0tDQVFFQXYzRmkNCkNQSDZXVFQzRzhrWW8vZUFTVmpwSW9NVHBzVWdRd0U3aFBIbWhVbWZKK3IyaEJ0T29MVGJjSmpITWdHeEJUNEgNClR1NzArazh2V1RBaTU2c1pWbXZpZ0FmODh4WjFnRGxSZStYNU5iWjBUcW1OZ2hQa3RqK3BBNFA2b3I2S0ZXcC8NCjNndkR0aGtVQmNycXc2Z0VsRHRHZkRJTjh3Qm1Jc2lOYVcwMmpCRVl0OU95SEdDME9Qb0NqTTdUM1VZSDNnbysNCjYxMTh5SHo3c0N0VHBKSmlhVkVsQldFYVJJR01MS2xEbGlQZnJEcUJtZzRweFJ5cDZWMGV0cDZlTUFvNXp2R0kNCmdQdExYY3d5N0lWaVF5VTBBbFluQVpHME8zQXFQMjZ4Nkp5SUFYMmYxUG5iVTIxZ25iOHM1MWlydUY5Ry9NN0UNCkd3TThDZXRKTVZ4cFJyUGdSd0lEQVFBQm80SUJGekNDQVJNd0R3WURWUjBUQVFIL0JBVXdBd0VCL3pBT0JnTlYNCkhROEJBZjhFQkFNQ0FRWXdIUVlEVlIwT0JCWUVGRHFhaFFjUVp5aTI3L2E5QlVGdUlNR1UyZy9lTUI4R0ExVWQNCkl3UVlNQmFBRk5MRXNOS1IxRXdSY2JOaHl6MmgvdDJvYXRUak1EUUdDQ3NHQVFVRkJ3RUJCQ2d3SmpBa0JnZ3INCkJnRUZCUWN3QVlZWWFIUjBjRG92TDI5amMzQXVaMjlrWVdSa2VTNWpiMjB2TURJR0ExVWRId1FyTUNrd0o2QWwNCm9DT0dJV2gwZEhBNkx5OWpjbXd1WjI5a1lXUmtlUzVqYjIwdloyUnliMjkwTG1OeWJEQkdCZ05WSFNBRVB6QTkNCk1Ec0dCRlVkSUFBd016QXhCZ2dyQmdFRkJRY0NBUllsYUhSMGNITTZMeTlqWlhKMGN5NW5iMlJoWkdSNUxtTnYNCmJTOXlaWEJ2YzJsMGIzSjVMekFOQmdrcWhraUc5dzBCQVFzRkFBT0NBUUVBV1F0VHZaS0dFYWNrZSsxYk1jOGQNCkgyeHd4Ymh1dms2NzlyNlhVT0V3Zjdvb1hHS1V3dU4rTS9mN1FuYUYyNVVjakNKWWRRa01pR1ZuT1FvV0NjV2cNCk9KZWt4U09UUDdRWXBnRUdSSkhqcDJrbnRGb2xmenEzTXMzZGhQOHFPQ2t6cE4xbnNvWCtvWWdnSEZDSnlOd3ENCjlrSUROMHptaU4vVnJ5VHlzY1BmekxYczRKbGV0MGxVSUR5VUdBekhIRklZU2FSdDRiTllDOG5ZN05tdUhES08NCktIQU40djZtRjU2RUQ3MVhjTE5hNlIrZ2hsTzc3M3ovYVF2Z1NNTzNrd3ZJQ2xURXJGMFVaemRzeXFVdk1RZzMNCnFtNXZqTHliNGxkZEpJR3ZsNWVjaEsxc3JEZE1adk5oa1JFZzVMNHduM3FrS1FtdzRUUmZaSGNZUUZIZmpEQ20NCnJ3PT0NCi0tLS0tRU5EIENFUlRJRklDQVRFLS0tLS0NCi0tLS0tQkVHSU4gQ0VSVElGSUNBVEUtLS0tLQ0KTUlJRUFEQ0NBdWlnQXdJQkFnSUJBREFOQmdrcWhraUc5dzBCQVFVRkFEQmpNUXN3Q1FZRFZRUUdFd0pWVXpFaA0KTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNUlFZHliM1Z3TENCSmJtTXVNVEV3THdZRFZRUUxFeWhIYnlCRQ0KWVdSa2VTQkRiR0Z6Y3lBeUlFTmxjblJwWm1sallYUnBiMjRnUVhWMGFHOXlhWFI1TUI0WERUQTBNRFl5T1RFMw0KTURZeU1Gb1hEVE0wTURZeU9URTNNRFl5TUZvd1l6RUxNQWtHQTFVRUJoTUNWVk14SVRBZkJnTlZCQW9UR0ZSbw0KWlNCSGJ5QkVZV1JrZVNCSGNtOTFjQ3dnU1c1akxqRXhNQzhHQTFVRUN4TW9SMjhnUkdGa1pIa2dRMnhoYzNNZw0KTWlCRFpYSjBhV1pwWTJGMGFXOXVJRUYxZEdodmNtbDBlVENDQVNBd0RRWUpLb1pJaHZjTkFRRUJCUUFEZ2dFTg0KQURDQ0FRZ0NnZ0VCQU42ZDErcFhHRW1oVyt2WFgwaUc2cjdkLytUdlp4ejBaV2l6VjNHZ1huZTc3WnRKNlhDQQ0KUFZZWVl3aHYydkxNMEQ5L0FsUWlWQkRZc29IVXdIVTlTMy9IZDhNK2VLc2FBN1VnYXk5cUs3SEZpSDdFdXg2dw0Kd2RoRkoyK3FOMWozaHliWDJDMzJxUmUzSDNJMlRxWVhQMldZa3RzcWJsMmkvb2pnQzk1LzVZMFY0ZXZMT3RYaQ0KRXFJVExkaU9yMThTUGFBSUJRaTJYS1ZsT0FSRm1SNmpZR0IweFVHbGNtSWJZc1VmYjE4YVFyNENVV1dvcmlNWQ0KYXZ4NEE2bE5mNEREK3F0YS9LRkFwTW9aRnY2eXlPOWVjdzN1ZDcyYTlubVl2TEVIWjZJVkRkMmdXTVpFZXdvKw0KWWloZnVrRUhVMWpQRVg0NGRNWDQvN1Zwa0krRWRPcVhHNjhDQVFPamdjQXdnYjB3SFFZRFZSME9CQllFRk5MRQ0Kc05LUjFFd1JjYk5oeXoyaC90Mm9hdFRqTUlHTkJnTlZIU01FZ1lVd2dZS0FGTkxFc05LUjFFd1JjYk5oeXoyaA0KL3Qyb2F0VGpvV2VrWlRCak1Rc3dDUVlEVlFRR0V3SlZVekVoTUI4R0ExVUVDaE1ZVkdobElFZHZJRVJoWkdSNQ0KSUVkeWIzVndMQ0JKYm1NdU1URXdMd1lEVlFRTEV5aEhieUJFWVdSa2VTQkRiR0Z6Y3lBeUlFTmxjblJwWm1sag0KWVhScGIyNGdRWFYwYUc5eWFYUjVnZ0VBTUF3R0ExVWRFd1FGTUFNQkFmOHdEUVlKS29aSWh2Y05BUUVGQlFBRA0KZ2dFQkFESkw4N0xLUHBIOEVzYWhCNHlPZDZBekJoUmNrQjRZOXdpbVBRb1orWWVBRVc1cDVKWVhNUDgwa1dOeQ0KT083TUhBR2pIWlFvcERIMmVzUlUxL2JsTVZnRG9zek9ZdHVVUlhPMXYwWEpKTFhWZ2dLdEkzbHBqYmkyVGM3UA0KVE1vekkrZ2NpS3FkaTBGdUZza2c1WW1lelR2YWNQZCttU1lnRkZRbHEyNXpoZWFiSVowS2JJSU9xUGpDRFBvUQ0KSG15Vzc0Y054QTloaTYzdWd5dVYrSTZTaEhJNTZ5RHFnKzJEelpkdUNMenJUaWEyY3l2azAvWk0vaVp4NG1FUg0KZEVyL1Z4cUhEM1ZJTHM5UmFSZWdBaEpobGRYUlFMSVFUTzdFckJCRHBxV2VDdFdWWXBvTno0aUN4VElNNUN1Zg0KUmVZTm55aWNzYmtxV2xldE53K3ZIWC9idlo4PQ0KLS0tLS1FTkQgQ0VSVElGSUNBVEUtLS0tLQ0KMYIDjTCCA4kCAQEwfTBpMQswCQYDVQQGEwJVUzEXMBUGA1UEChMORGlnaUNlcnQsIEluYy4xQTA/BgNVBAMTOERpZ2lDZXJ0IFRydXN0ZWQgRzQgQ29kZSBTaWduaW5nIFJTQTQwOTYgU0hBMzg0IDIwMjEgQ0ExAhAG86DNbpa5mQqLqFXowqNUMAsGCWCGSAFlAwQCAaCB5DAYBgkqhkiG9w0BCQMxCwYJKoZIhvcNAQcBMBwGCSqGSIb3DQEJBTEPFw0yMzEyMDQxODQxMjNaMC8GCSqGSIb3DQEJBDEiBCCc1uOHEB10HvI+PFP7Gzd7O9thuD6Pb2L2oF4fHoK+ETB5BgkqhkiG9w0BCQ8xbDBqMAsGCWCGSAFlAwQBKjALBglghkgBZQMEARYwCwYJYIZIAWUDBAECMAoGCCqGSIb3DQMHMA4GCCqGSIb3DQMCAgIAgDANBggqhkiG9w0DAgIBQDAHBgUrDgMCBzANBggqhkiG9w0DAgIBKDANBgkqhkiG9w0BAQEFAASCAgCjv47XyRS0L1u8qA/0xnpY/BXtQMiS/IxSCsrnMGmkNSF4GkRX6KlDX6Bkev9Z52U+BcNauS99qa+avp4YeVJana94Pu4E3VZwoRv2hj1VZo2a2o/DgBBwyxkm9fHFeNgc7HuJfBp/K2vSYmRItZKmu2/atvauH4VObPSKG15rm74aox7sI5OBwhdgB82HRAxCUqfqu4/koXCOCBs6pw0UWZ5sGXhKtqwo+/CJ+zBtpRplP0UzWeqE7onEAIio0vxAwI8/CVV8pSHWlwjQjjkhuRx5i4FEMJyLAP528hq5d/4xVCHWTyglBVqum0cSXyJ35bNAciuTLCJ/iJjWChsCKrtiuIkeVLNvz95eUQnueIzoJ4pKGUonHs18ceJORaNZglX/xRP1c3XGqEcWMrx9M6gsR9DHEbq9AyfNT7oOOfQfLvaa+gkYUhG8fvAGgh6NSnN2SRB7RhHJwTKvLYUjoZuml/jOIiSBZhfGFtH831RprUy5vBGScHxWmsJ3TFzZ7DcfIfBuHHlgJuY2j1J5M55JvSwwxzHYs8KDTTQDv+Wfw3alChyceI5ECGGmVPJJHwmSnkMKMiDbdrdzd/+sbT2XvHuFDgzmzFVGJPM7M9lRxGQEB/Rb0O8XURI3K7RfSUSP8wXJoVmy6WRoP2Q1w7XDiNu1FTPDYgYD6XXNQg=='
EMBEDDED_BLADE_MASK='__CP_BLADE_MASK__'
EMBEDDED_CONFIG_DAT='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'
# <<REPLACE END

ARCH=$(uname -m)

# function to check if embedded argument contains a non-placeholder value
function is_valid_embedded_arg() {
  local ext_arg=$1
  [[ ! $1 =~ ^__CP.*__$ ]]
}

function is_suse() {
  [[ $g_distro_name == "leap" || $g_distro_name == "sles" ]]
}

# apply valid embedded arguments
function apply_embedded_arguments() {
  if is_valid_embedded_arg "$EMBEDDED_MGMT_FQDN"; then SBA_MANAGEMENT_URL="https://${EMBEDDED_MGMT_FQDN}"; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_KEY"; then SBA_MANAGEMENT_KEY=$EMBEDDED_MGMT_KEY; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_CA_CERT"; then g_mgmt_ca_cert_data_base64=$EMBEDDED_MGMT_CA_CERT; fi
  if is_valid_embedded_arg "$EMBEDDED_MGMT_CA_CERT_SIG"; then g_mgmt_ca_cert_sig_data_base64=$EMBEDDED_MGMT_CA_CERT_SIG; fi
  if is_valid_embedded_arg "$EMBEDDED_CONFIG_DAT"; then g_da_config_dat_content=$EMBEDDED_CONFIG_DAT; SBA_CONFIG_DAT_FILE=$g_da_config_dat_file; fi
}

# write log rotate file for a given log
function logrotate_log_file() {
  local logrotate_base_path=$1
  local logrotate_file_path=$2
  local log_path=$3

  if [[ -d $logrotate_base_path ]]; then
    echo "${log_path} {" >$logrotate_file_path
    echo "  size 10M" >>$logrotate_file_path
    echo "  rotate 5" >>$logrotate_file_path
    echo "}" >>$logrotate_file_path
  fi
}

# write environment file to be used by cron jobs and possibly product services
function write_env_file() {
  mkdir -p $g_save_folder
  : >$g_env_file
  set +u
  echo "DEBIAN_FRONTEND=noninteractive" >>$g_env_file
  echo "SBA_REPO_TYPE=$SBA_REPO_TYPE" >>$g_env_file
  echo "PATH=$PATH" >>$g_env_file
  echo "HTTP_PROXY=$HTTP_PROXY" >>$g_env_file
  echo "http_proxy=$http_proxy" >>$g_env_file
  echo "HTTPS_PROXY=$HTTPS_PROXY" >>$g_env_file
  echo "https_proxy=$https_proxy" >>$g_env_file
  echo "NO_PROXY=$NO_PROXY" >>$g_env_file
  echo "no_proxy=$no_proxy" >>$g_env_file
  set -u
}

# update a single variable in the environment file
function update_env_file() {
  local key=$1
  local value=$2
  if [[ $2 == "none" ]]; then
    value=""
  fi
  if [[ -f $g_env_file ]]; then
    sed -i "s|^\($key=\).*|\1$value|i" $g_env_file
  fi
}

# remove environment file if no products are installed
function remove_env_file() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_env_file
    set +e
    rm -df $g_save_folder
    set -e
  fi
}

# manually clean the garbage
function remove_leftovers() {
  #clamav and clamd traces
  echo "Removing clamav and clamd traces"
  rm -rfv "/etc/clam.d"
  rm -rfv "/usr/share/clamav"
  rm -rf "/etc/checkpoint/common/install_cronjob.sh"
  rm -rf "/etc/checkpoint/common"

  local explicit_files=(
    "/var/cache/checkpoint/cpmgmt/logcache.cache"
    "/var/lib/checkpoint/cpmgmt/telemetry_msgs_sent.json"
    "/var/lib/checkpoint/da/config.dat"
    "/var/cache/checkpoint/cpsba/bg/linux_rules_version"
    "/var/lib/checkpoint/cpam/cpam-status.json"
    "/var/lib/checkpoint/cpam/infections.json"
    "/var/log/checkpoint/common/sbalinux-update.log"
    "/var/log/checkpoint/common/sbalinux-product-update.log"
  )
  for f in "${explicit_files[@]}" ; do
    rm -rf "$f" && echo "$f removed"
  done

  local explicit_dirs=(
    "/var/cache/checkpoint/cpsba/bg"
    "/var/cache/checkpoint/cpsba"
    "/var/cache/checkpoint/cpmgmt"
    "/var/cache/checkpoint"
    "/var/lib/checkpoint/cpam"
    "/var/lib/checkpoint/cpmgmt"
    "/var/lib/checkpoint/da"
    "/var/lib/checkpoint"
    "/var/log/checkpoint/cpam"
    "/var/log/checkpoint/common"
    "/var/log/checkpoint"
    "/etc/checkpoint"
  )
  for d in "${explicit_dirs[@]}" ; do
    rmdir "$d" && echo "Empty $d dir is removed"
  done
}

# offline_package: extract self contained archive from install_offline.sh to mktemp
function unpack_bootstrap() {
  echo "unpack_bootstrap started for $0"
  if ! grep -m 1 "^__ARCHIVE_FOLLOWS__" "$0" ; then
    echo "Error: this offline package does not seem to have embedded archive"
    echo "Please ensure, that you're using correct package (install_offline.sh)"
    exit 1
  fi
  awk 'f; /^__ARCHIVE_FOLLOWS__/{f=1}' "$0" | base64 -d | tar -C "$g_bootstrap_dir" -xz
  echo "unpack_bootstrap finished"
  echo "ls $g_bootstrap_dir"
  ls -la "$g_bootstrap_dir"
}

function prepare_offline_yum_package() {
  # NOTE: --disablerepo=* is used because offline repo is not configured at the moment

  run_for "centos_7,redhat_7,oracle_7,amazon_2" yum install -y --disablerepo=* \
    "$g_bootstrap_dir"/rpm/libxml2*.rpm \
    "$g_bootstrap_dir"/rpm/libxml2-python*.rpm \
    "$g_bootstrap_dir"/rpm/python-chardet*.rpm \
    "$g_bootstrap_dir"/rpm/python-kitchen*.rpm \
    "$g_bootstrap_dir"/rpm/yum-utils*.rpm || /bin/true

  run_for "centos_8,redhat_8,oracle_8,redhat_9,centos_9" yum install -y --disablerepo=* \
    "$g_bootstrap_dir"/rpm/dnf-plugins-core*.rpm \
    "$g_bootstrap_dir"/rpm/python3-dnf-plugins-core*.rpm \
    "$g_bootstrap_dir"/rpm/yum-utils*.rpm || /bin/true
}

function prepare_offline_package() {
  if [[ "$g_got_remote_install_product_arg" -eq 0 ]]; then
    g_remote_install_products="am"
    g_got_remote_install_product_arg=1
  fi

  g_bootstrap_dir="$(mktemp -d)"
  unpack_bootstrap
  mkdir -p "$g_offline_repo_path"
  cp -Rafv "$g_bootstrap_dir/$g_package_type/"* "$g_offline_repo_path"

  if [ "$g_package_type" = "rpm" ]; then
    prepare_offline_yum_package
  fi
}

function remove_bootstrap_if_needed() {
  [ -n "$g_bootstrap_dir" ] && echo "g_bootstrap_dir: $g_bootstrap_dir"
  if [ -n "$SBA_OFFLINE_PACKAGE" ] && [ -d "$g_bootstrap_dir" ] ; then
    echo "cleaning temp offline_package dir"
    rm -rf "$g_bootstrap_dir"
  fi
}

# schedule cron job that will retry to install if previous attempt failed
function schedule_install_cron_job() {
  if [[ $g_install_with_cron_job == "no" || -f $g_cron_file_reinstall_path ]]; then
    return
  fi

  save_self

  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-install"
  local log_base_path="/var/log/checkpoint/common"
  local log_path="${log_base_path}/sbalinux-install.log"
  local cron_job_install_script="$g_save_folder/install_cronjob.sh"

  local env_vars_exports="set -o allexport; source $g_env_file; set +o allexport"
  local echo_log_cmd="echo \"--- starting install: \$(date) ---\""
  local last_install_command="${g_saved_script} ${g_args}"

  mkdir -p $log_base_path

  : >$cron_job_install_script
  chmod 744 $cron_job_install_script
  echo '#!/bin/bash' >>$cron_job_install_script
  echo $env_vars_exports >>$cron_job_install_script
  echo $echo_log_cmd >>$cron_job_install_script
  echo $last_install_command >>$cron_job_install_script
  echo "$g_install_cron_timing  root  $cron_job_install_script >> ${log_path} 2>&1" >>$g_cron_file_reinstall_path

  logrotate_log_file "$logrotate_base_path" "$logrotate_file_path" "$log_path"
}

# remove install retry cron job, should be called after installation success
function remove_install_cron_job() {
  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-install"
  local cron_job_install_script="$g_save_folder/install_cronjob.sh"

  if [[ $g_install_with_cron_job == "no" ]]; then
    return
  fi

  # clean-up any additional cron job related files
  remove_self
  rm -f $g_cron_file_reinstall_path
  rm -f $g_cron_file_switch_repo_path
  rm -f $logrotate_file_path
  rm -f $cron_job_install_script
  set +e
  rm -df $g_save_folder
  set -e
}

function is_http_url() {
  if [[ $1 =~ ^http(s{0,1}):\/\/.*$ ]]; then
    echo "true"
  fi
}

function is_guid() {
  if [[ $1 =~ ^[0-9a-f]{8}(-[0-9a-f]{4}){3}-[0-9a-f]{12}$ ]]; then
    echo "true"
  fi
}

function is_sysdig_needed() {
  if [ "$g_operation" == "install" ]; then
    test "$g_remote_install_products" != "am"
  elif [ "$g_operation" == "update" ]; then
    test "$g_update_product" != "am"
  fi
}

function is_centos_8_based() {
  [[ ($g_distro_name == "centos" && $g_distro_version -ge 8) \
    || ($g_distro_name == "redhat" && $g_distro_version -ge 8) \
    || ($g_distro_name == "oracle" && $g_distro_version -ge 8) \
    || ($g_distro_name == "euler") ]]
}

function is_euleros() {
  [[ ($g_distro_name == "euler") ]]
}

function is_centos_9_based() {
  [[ ($g_distro_name == "centos" && $g_distro_version -ge 9) || \
     ($g_distro_name == "redhat" && $g_distro_version -ge 9) ]]
}

function is_ubuntu_22() {
  [[ ($g_distro_name == "ubuntu" && $g_distro_version -eq 22) ]]
}

function check_offline_package() {
  if grep -q -m 1 "^__ARCHIVE_FOLLOWS__" "$0" ; then
    export SBA_OFFLINE_PACKAGE=yes
  fi
}

function check_install_cmd_args() {
  if [[ -z $SBA_MANAGEMENT_URL ]]; then
    echo "Missing management server configuration, for usage run: $0 --help"
    exit 1
  fi

  # accept base64 encoded key
  if [[ ! $SBA_MANAGEMENT_KEY =~ ^[A-Za-z0-9+/=]*$ ]]; then
    echo "Illegal management server key"
    exit 1
  fi

  # Validation of URL is not strict. The possible one to cover domain name and IPv4 address is:
  # ^https?:\/\/(((?!-)[A-Za-z0-9-]{1,63}(?<!-)\.)+[A-Za-z]{2,6}|([0-9]{1,3}\.){3}[0-9]{1,3}(:[0-9]+)?)$
  if [[ ! $SBA_MANAGEMENT_URL =~ ^https?:\/\/ ]]; then
    echo "Illegal management server url $SBA_MANAGEMENT_URL. It should be in form http(s)://<IP|hostname>"
    exit 1
  fi

  if [[ ! -z $HTTP_PROXY && -z $(is_http_url $HTTP_PROXY) ]]; then
    echo "Illegal http proxy url"
    exit 1
  fi

  if [[ ! -z $HTTPS_PROXY && -z $(is_http_url $HTTPS_PROXY) ]]; then
    echo "Illegal https proxy url"
    exit 1
  fi

  if [[ -z $g_install_source ]]; then
    echo "Missing install source, for usage run: $0 --help"
    exit 1
  fi

  if [[ $g_install_source == "remote" ]]; then
    if [[ -z $g_remote_install_products ]]; then
      echo "Please specify product to install from the remote package repository"
      exit 1
    fi
    if [[ ! -z $g_local_install_file_name ]]; then
      echo "Package file name cannot be specified when installing from remote package repository"
      exit 1
    fi
  elif [[ $g_install_source == "local" ]]; then
    if [[ -z $g_local_install_file_name ]]; then
      echo "Please specify package file name to install"
      exit 1
    fi
  fi

  if [[ ! -z $g_version_to_install ]]; then
    if [[ $g_install_source != "remote" ]]; then
      echo "Version to install can only be specified for installation from a remote repository"
      exit 1
    fi
    if [[ ! $g_version_to_install =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
      echo "Version to install is invalid"
      exit 1
    fi
  fi

  if [[ ! -z $g_install_with_cron_job ]]; then
    if [[ $g_install_with_cron_job != "yes" && $g_install_with_cron_job != "no" ]]; then
      echo "Invalid argument for 'retry' option, please specify 'yes' or 'no'"
      exit 1
    fi
  fi

  if [[ ! -z $g_should_schedule_upgrade ]]; then
    if [[ $g_should_schedule_upgrade != "yes" && $g_should_schedule_upgrade != "no" ]]; then
      echo "Invalid argument for 'upgrade' option, please specify 'yes' or 'no'"
      exit 1
    fi
  fi

  if [[ ! -z $SBA_VDS_LOCATION_GUID && -z $(is_guid $SBA_VDS_LOCATION_GUID) ]]; then
    echo "Illegal group id. Group id should be in GUID format: xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
    exit 1
  fi
}

function check_umask() {
  local um
  um=$(umask)
  local supported_umask="0022"
  if [[ $(umask) != "0022" ]] ; then
    echo "Error!"
    echo "Installation script has detected an umask: \"${um}\"."
    echo "Only ${supported_umask} is supported. Other variants might lead to"
    echo "unpredictable behavior when working as an unprivileged"
    echo "user. Refused to proceed."
    exit 1
  fi
}

function force_env_vars() {
  if [ "$g_distro_name" == "debian" ] && [ "$g_distro_version" -eq 11 ]; then
    export USE_CPCLAM=false
  fi
}

function to_lower() {
  echo $(echo $1 | tr "[:upper:]" "[:lower:]")
}

function ensure_forced_distro(){
  OLD_IFS=$IFS
  IFS='_'
  read -ra distro <<< "$SBA_FORCE_DISTRO"
  g_distro_name=$(to_lower ${distro[0]})
  g_distro_version=${distro[1]}
  echo "Forced to use $g_distro_name $g_distro_version distribution"
  IFS=$OLD_IFS
}

function detect_package_type() {
  # check architecture
  if [[ ! $ARCH == "x86_64" && ! $ARCH == "aarch64" ]]; then
    return
  fi

  if [[ ! -z ${SBA_FORCE_DISTRO:=""} ]]; then
    ensure_forced_distro
  else
    # check distro
    if [[ -f "/etc/debian_version" ]]; then  # debian-based distros
      if [[ ! $ARCH == "x86_64" ]]; then
        return
      fi

      if [[ -f "/etc/lsb-release" ]]; then
        . "/etc/lsb-release"
        g_distro_name=$(echo "$DISTRIB_ID" | tr '[:upper:]' '[:lower:]')
        g_distro_version=${DISTRIB_RELEASE%%.*}
      else
        g_distro_name="debian"
        g_distro_version=$(cut -d'.' -f1 "/etc/debian_version")
      fi
    elif [ -f "/etc/system-release-cpe" ]; then  # centos-based distros
      g_distro_name=$(cut -d':' -f3 "/etc/system-release-cpe")
      g_distro_version=$(cut -d':' -f5 "/etc/system-release-cpe" | cut -d'.' -f1 | sed 's/[^0-9]*//g')
      if [[ $g_distro_name == "o" ]]; then
        g_distro_name=$(cut -d':' -f4 "/etc/system-release-cpe")
        g_distro_version=$(cut -d':' -f6 "/etc/system-release-cpe")
      elif [[ $g_distro_name == "euler" ]]; then
        g_distro_version=$(cut -d':' -f5 "/etc/system-release-cpe" | sed 's/[^0-9]*//g')
      fi
    elif [ -f /etc/os-release ] ; then  # suse-based distros
      g_distro_name=$(grep -Po '(?<=^CPE_NAME=).*(?=)' "/etc/os-release" | cut -d ':' -f 4)
      g_distro_version="$(grep -Po '(?<=VERSION_ID=").*(?=")' "/etc/os-release" | tr -dc '0-9')"
    fi
  fi

  # debian-based distros
  if [[ ($g_distro_name == "ubuntu" && $g_distro_version -ge 16 && $g_distro_version -le 22) \
     || ($g_distro_name == "debian" && $g_distro_version -ge 9  && $g_distro_version -le 11) ]]; then
    g_package_type="deb"
  fi

  # centos-based distros
  if [[ ($g_distro_name == "centos" && $g_distro_version -ge 7 && $g_distro_version -le 9) \
     || ($g_distro_name == "redhat" && $g_distro_version -ge 7 && $g_distro_version -le 9) \
     || ($g_distro_name == "oracle" && $g_distro_version -ge 7 && $g_distro_version -le 8) \
     || ($g_distro_name == "amazon" && $g_distro_version -eq 2) \
     || ($g_distro_name == "euler" && ($g_distro_version -eq 205 || $g_distro_version -eq 208 \
                                    || $g_distro_version -eq 209 || $g_distro_version -eq 2010)) ]]; then
      g_package_type="rpm"
      g_rpm_repo_config_file="/etc/yum.repos.d/sbalinux.repo"
  fi

  # suse-based distros
  if [[ ($g_distro_name == "leap" && ($g_distro_version -eq 423 || $g_distro_version -eq 153)) \
     || ($g_distro_name == "sles" && ($g_distro_version -eq 125 || $g_distro_version -eq 153)) ]]; then
      g_package_type="rpm"
      g_rpm_repo_config_file="/etc/zypp/repos.d/sbalinux.repo"
  fi
}

function set_repo_type() {
  g_repo_type=${SBA_REPO_TYPE:=$g_repo_type}
}

function set_blades_from_products() {
  local products_str=$1

  # split into array with unique elements
  g_blades=($(echo $products_str | tr "," "\n" | sort -u | tr "\n" " "))

  if [[ ${#g_blades[@]} -eq 0 ]]; then
      if [[ $ARCH == "x86_64" ]]; then
        g_blades=("edr" "am")
      else
        g_blades=("am")
      fi
  fi

  for product in ${g_blades[*]}; do
    if [[ -z ${g_prod_to_blade[$product]:=""} ]]; then
      echo "invalid product '$product'"
      exit 1
    fi
  done
}

function list_contains_item() {
  local list="$1"
  local item="$2"
  if [[ $list =~ (^|[[:space:]])"$item"($|[[:space:]]) ]]; then
    result=0
  else
    result=1
  fi
  return $result
}

function bypass_proxy() {
  if [ $# -eq 0 ]; then
    # No argument supplied. no_proxy remains unchanged
    return
  fi

  local fqdn=$1
  if [[ -z ${no_proxy:=""} ]]; then
    export no_proxy=$fqdn
  else
    export no_proxy="$no_proxy,$fqdn"
  fi
  if [[ -z ${NO_PROXY:=""} ]]; then
    export NO_PROXY=$fqdn
  else
    export NO_PROXY="$NO_PROXY,$fqdn"
  fi
}

function configure_deb_offline_repo() {
  # import public keys
  cat "$g_bootstrap_dir"/pks/public | apt-key add -

  # configure /etc/apt/sources.list.d/sbalinux_offline
  local config_file=$g_deb_repo_config_file
  local repo_name=sbalinux_offline
  echo "deb [trusted=yes] file://$g_offline_repo_path ./" >$config_file
}

# configure sbalinux deb repo
function configure_deb_repo() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    configure_deb_offline_repo
    return
  fi
  local repo_type=$1
  local config_file=$g_deb_repo_config_file

  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.public"
    local repo_url="https://${repo_fqdn}/sbalinux/packages/deb"
  elif [[ $repo_type == "dev"  ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/api/gpg/key/public"
    local repo_url="https://${repo_fqdn}/artifactory/SBA_DEB"
    # add proxy bypass for artifactory
    bypass_proxy ${repo_fqdn}
  else
    echo "invalid repository type"
    exit 1
  fi

  mkdir -p $(dirname "$config_file")
  curl -s $key_url | apt-key add -
  echo "deb [arch=amd64] ${repo_url} ${repo_type} ${g_distro_name}_${g_distro_version}" >$config_file
}

function configure_rpm_offline_repo() {
  echo "Importing sbalinux key..."
  rpm --import "$g_bootstrap_dir/pks/sbalinux-gpg-key.asc"

  if is_sysdig_needed ; then
    echo "Importing DRAIOS key..."
    rpm --import "$g_bootstrap_dir/pks/DRAIOS-GPG-KEY.public"
  fi

  if is_centos_8_based; then
    echo "Importing CentOS 8 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-CentOS-Official"
  else
    if [ "$ARCH" = "x86_64" ]; then
      echo "Importing CentOS 7 key for x86_64..."
      rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-CentOS-7"
    elif [ "$ARCH" = "aarch64" ]; then
      echo "Importing CentOS 7 key for aarch64..."
      rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-CentOS-7-aarch64"
    fi
  fi

  if is_centos_9_based ; then
    echo "Importing EPEL 9 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-EPEL-9"
  elif is_centos_8_based ; then
    echo "Importing EPEL 8 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-EPEL-8"
  else
    echo "Importing EPEL 7 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-EPEL-7"
  fi

  if [ "$g_distro_name" = "oracle" ]; then
    echo "Importing Oracle 7 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-oracle-ol7"
    echo "Importing Oracle 8 key..."
    rpm --import "$g_bootstrap_dir/pks/RPM-GPG-KEY-oracle-ol8"
  fi

  local config_file=$g_rpm_repo_config_file
  local repo_name=sbalinux_offline
  {
    echo "[${repo_name}]"
    echo "name=${repo_name}"
    echo "baseurl=file://$g_offline_repo_path"
    echo "enabled=1"
    echo "gpgcheck=1"
    echo "sslverify=1"
    echo "priority=5"
  } > "$config_file"
}

# make sysdig keys repo known to system, so package downloaded from CP repos could be verified
function import_sysdig_rpm_key() {
  rpm --quiet --import https://s3.amazonaws.com/download.draios.com/DRAIOS-GPG-KEY.public
}

# configure sbalinux rpm repo
function configure_rpm_repo() {
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    configure_rpm_offline_repo
    return
  fi
  local repo_type=$1
  local config_file=$g_rpm_repo_config_file
  local repo_name="sbalinux_${repo_type}"
  # Leave pure sbalinux only for prod
  [[ $repo_type == "prod" ]] && repo_name="sbalinux"
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local repo_url="https://${repo_fqdn}/sbalinux/packages/rpm"
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.asc"
    local gpgcheck=1
    local sslverify=1
    local disable_proxy=0
  elif [[ $repo_type == "dev" ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local repo_url="https://${repo_fqdn}/artifactory/SBA_RPM"
    local key_url="https://${repo_fqdn}/artifactory/SBA_GEN/repo_public_keys/rpm/sbalinux-gpg-key.asc"
    local gpgcheck=0
    local sslverify=0
    local disable_proxy=1
    # add proxy bypass for artifactory
    bypass_proxy $repo_fqdn
  else
    echo "invalid repository type"
    exit 1
  fi

  is_sysdig_needed && import_sysdig_rpm_key
  rpm --import $key_url
  echo "[${repo_name}]" >$config_file
  echo "name=${repo_name}" >>$config_file
  echo "baseurl=${repo_url}/${repo_type}/${g_distro_name}_${g_distro_version}" >>$config_file
  echo "enabled=1" >>$config_file
  echo "gpgcheck=${gpgcheck}" >>$config_file
  echo "sslverify=${sslverify}" >>$config_file

  # pin repo priority becuase we want some dependencies to be hosted on our own repo
  # NOTE: to make repo priority work in centos/redhat older than 8 we need to install the yum-priorities plugin!
  echo "priority=1" >>$config_file

  if [[ $disable_proxy -gt 0 ]]; then
    echo "proxy=_none_" >>$config_file
  fi
  # refresh zypper for gpg key auto trust
  if is_suse ; then
    zypper --gpg-auto-import-keys refresh
  fi
}

function remove_deb_repo() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_deb_repo_config_file
  fi
}

function remove_rpm_repo() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_rpm_repo_config_file
  fi
}

function create_clam_user_apt() {
  if ! id -u clamav ; then
    mkdir -p /var/lib/clamav
    /usr/sbin/adduser --system --no-create-home --quiet --disabled-password --disabled-login --shell /bin/false --group --home /var/lib/clamav clamav
  fi
}

function create_clam_users_yum() {
  if ! id -u clamscan ; then
    /usr/sbin/groupadd -r clamscan
    /usr/sbin/useradd -r -g clamscan -d / -s /sbin/nologin -c "Clamav scanner user" clamscan
  fi

  if ! id -u clamupdate ; then
    mkdir -p /var/lib/clamav
    /usr/sbin/groupadd -r clamupdate
    /usr/sbin/useradd -r -g clamupdate -d /var/lib/clamav -s /sbin/nologin -c "Clamav database update user" clamupdate
  fi
}

function extract_clam_databases() {
    local database_dir=/var/lib/clamav
    mkdir -p "$database_dir"
    local clam_user="$1"
    cp -afv "$g_bootstrap_dir"/cvds/{daily,main,bytecode}.cvd "$database_dir"
    chown "$clam_user:$clam_user" "$database_dir"
    chmod o+r "$database_dir"/*.cvd
}

function install_prereq_apt() {
  # preconfigure samba-common to prevent it from popping a dialog requiring user input
  echo "samba-common samba-common/dhcp boolean false" | debconf-set-selections
  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    dpkg -i "$g_bootstrap_dir"/deb/apt-transport-https*.deb || /bin/true
    dpkg -i "$g_bootstrap_dir"/deb/{libcurl,curl}*.deb || /bin/true
    dpkg -i "$g_bootstrap_dir"/deb/glibc-tools*.deb || /bin/true

    # setup gnupg
    dpkg -i "$g_bootstrap_dir"/deb/{libassuan0,libksba8,libnpth0,pinentry}*.deb || /bin/true
    dpkg -i "$g_bootstrap_dir"/deb/{gpg,dirmngr}*.deb || /bin/true
    dpkg -i "$g_bootstrap_dir"/deb/gnupg*.deb || /bin/true

    apt-get update
    create_clam_user_apt
    extract_clam_databases "clamav"
    return
  fi
  # common
  apt-get update
  apt-get install -y curl gnupg apt-transport-https

  if is_ubuntu_22 ; then
    apt-get install -y glibc-tools
  fi

  if is_sysdig_needed; then
    apt-get install -y linux-headers-$(uname -r) || kernel_warning
  fi
}

function run_for() {
  local distros="$1"
  shift
  IFS=',' read -r -a dist_arr <<< "$distros"
  for distro_pack in "${dist_arr[@]}" ; do
    local dist
    local vers
    dist=$(cut -d'_' -f1 <<< "$distro_pack")
    vers=$(cut -d'_' -f2 <<< "$distro_pack")
    [ "$g_distro_name" != "$dist" ] && continue
    # continue if vers is not specified, e.g "euler" and version != current version
    [[ "${vers}" != "$dist" && "${g_distro_version}" -ne "${vers}" ]] && continue
    "$@" && break
  done
}

function install_prereq_yum_offline() {
  run_for "centos_7,oracle_7,redhat_7,amazon_2,euler_205" yum install -y --skip-broken \
    "$g_bootstrap_dir"/rpm/elfutils*.rpm \
    "$g_bootstrap_dir"/rpm/libcurl*.rpm \
    "$g_bootstrap_dir"/rpm/curl*.rpm \
    "$g_bootstrap_dir"/rpm/libidn2*.rpm \
    "$g_bootstrap_dir"/rpm/yum-plugin-priorities*.noarch.rpm \
    "$g_bootstrap_dir"/rpm/yum-plugin-versionlock*.noarch.rpm || /bin/true

  run_for "centos_8,redhat_8,oracle_8,centos_9,redhat_9" yum install -y --skip-broken \
    "$g_bootstrap_dir"/rpm/zlib-devel*.rpm \
    "$g_bootstrap_dir"/rpm/elfutils*.rpm \
    "$g_bootstrap_dir"/rpm/openssl-libs*.rpm \
    "$g_bootstrap_dir"/rpm/libcurl*.rpm \
    "$g_bootstrap_dir"/rpm/curl*.rpm \
    "$g_bootstrap_dir"/rpm/python3-dnf-plugins-core*.rpm \
    "$g_bootstrap_dir"/rpm/python3-dnf-plugin-versionlock*.rpm || /bin/true

  # For semanage
  run_for "euler_208,euler_209" yum install -y --skip-broken \
    "$g_bootstrap_dir"/rpm/python3*.rpm \
    "$g_bootstrap_dir"/rpm/dnf*.rpm \
    "$g_bootstrap_dir"/rpm/yum*.rpm \
    "$g_bootstrap_dir"/rpm/policycoreutils*.rpm \
    "$g_bootstrap_dir"/rpm/libdnf*.rpm || /bin/true

  # For semanage
  run_for "centos_7,oracle_7,redhat_7,amazon_2,euler_205" yum install -y --skip-broken  \
    "$g_bootstrap_dir"/rpm/audit*.rpm \
    "$g_bootstrap_dir"/rpm/checkpolicy*.rpm \
    "$g_bootstrap_dir"/rpm/libsemanage*.rpm \
    "$g_bootstrap_dir"/rpm/setools-libs*.rpm \
    "$g_bootstrap_dir"/rpm/policycoreutils*.rpm \
    "$g_bootstrap_dir"/rpm/python-IPy*.rpm \
    "$g_bootstrap_dir"/rpm/libcgroup*.rpm || /bin/true

  # For semanage
  run_for "centos_8,redhat_8,oracle_8,centos_9,redhat_9" yum install -y --skip-broken \
    "$g_bootstrap_dir"/rpm/checkpolicy*.rpm \
    "$g_bootstrap_dir"/rpm/policycoreutils*.rpm \
    "$g_bootstrap_dir"/rpm/python3-audit*.rpm \
    "$g_bootstrap_dir"/rpm/python3-libsemanage*.rpm \
    "$g_bootstrap_dir"/rpm/python3-policycoreutils*.rpm \
    "$g_bootstrap_dir"/rpm/python3-setools*.rpm || /bin/true

  create_clam_users_yum
  extract_clam_databases "clamupdate"
}

function install_prereq_zypper() {
  zypper -n in policycoreutils-python
}

function allow_freshclam_logging() {
  echo "Build SELinux module to allow freshclam logging."
  echo "module freshclam_log_allow 1.0;" \
       "require { type var_log_t;   type antivirus_t;class file open;     "  \
       "          type antivirus_t; type var_log_t;  class file setattr; }" \
       "allow antivirus_t var_log_t:file setattr; " \
       "allow antivirus_t var_log_t:file open;" > freshclam_log_allow.te
  checkmodule -M -m -o freshclam_log_allow.mod  freshclam_log_allow.te
  semodule_package -o freshclam_log_allow.pp -m freshclam_log_allow.mod

  echo "Install SELinux module to allow freshclam logging."
  semodule -v -i freshclam_log_allow.pp

  rm -f freshclam_log_allow.*
}

function install_prereq_yum() {
  # Used for online and offline installation for Euler OS
  if is_euleros ; then
    allow_freshclam_logging
  fi

  if [ -n "$SBA_OFFLINE_PACKAGE" ] ; then
    install_prereq_yum_offline
    return
  fi

  if is_centos_8_based ; then
    local yum_plugins="yum-plugin-versionlock"
  else
    local yum_plugins="yum-plugin-versionlock yum-priorities"
  fi

  if  [ -z "$g_force_no_sbalinux_repo" ] && ! yum repolist | grep epel &>/dev/null; then
    if [[ $g_distro_name == "amazon" ]]; then
      amazon-linux-extras install epel -y
    elif is_euleros ; then
      rpm --quiet --import https://dl.fedoraproject.org/pub/epel/RPM-GPG-KEY-EPEL-8
      return
    else
      local epel_rpm_url=$(printf "$g_epel_rpm_url_template" "$g_distro_version")
      if ! yum install -y "${epel_rpm_url}" ; then
        echo "Failed to install EPEL repo. Check that download URL is accessible: ${epel_rpm_url}"
      fi
    fi
  fi

  yum install -y curl ${yum_plugins}

  # package that provides semanage - needed for AM
  if is_centos_8_based ; then
    local semanage_pkg_name="policycoreutils-python-utils"
  else
    local semanage_pkg_name="policycoreutils-python"
  fi
  yum install -y $semanage_pkg_name

  if is_sysdig_needed && [[ $ARCH == "x86_64" && ($g_distro_name != "euler") ]]; then
    # needed for EDR
    KERNEL_VERSION=$(uname -r)
    if [[ $KERNEL_VERSION == *uek* ]]; then
      yum -q -y install kernel-uek-devel-$KERNEL_VERSION || kernel_warning
    else
      yum -q -y install kernel-devel-$KERNEL_VERSION || kernel_warning
    fi
  fi
}

function kernel_warning() {
  echo "Unable to find kernel development files for the current kernel version $(uname -r)"
  echo "This usually means that your system is not up-to-date or you installed a custom kernel version."
  echo "Please install up-to-date kernel or reboot system to load different installed one"
  exit 2
}

function get_deb_install_candidate() {
  local pkg_name=$1
  local result=$(apt-cache policy $pkg_name | grep 'Candidate:' | sed -r 's/^\s+Candidate:\s+//')
  echo $result
}

function install_deb_pkg_from_file() {
  BASEDIR=$(dirname "$0")
  local pkg_file=$BASEDIR/$1

  apt-get update
  apt-get install -y $pkg_file
}

function install_rpm_pkg_from_file() {
  local pkg_file=$1
  BASEDIR=$(dirname "$0")
  if ! is_suse ; then
    yum install -y $BASEDIR/$pkg_file
  else
    zypper -n in $BASEDIR/$pkg_file
  fi
}

function get_deb_version_to_install() {
  local pkg_name=$1
  local product=$2
  if [[ -z $g_version_to_install ]]; then
    local version=$(get_deb_install_candidate $pkg_name)
  else
    local version=$g_version_to_install
  fi
  echo $version
}

function install_deb_pkg_from_repo() {
  apt-get update
  local product="la"
  local pkg_name=${g_prod_to_pkg[$product]}
  local version=$(get_deb_version_to_install "$pkg_name" "$product")
  apt-get install -y $pkg_name=$version
}

function install_rpm_pkg_from_repo() {
  local product="la"
  if [[ -z $g_version_to_install ]]; then
    if ! is_suse ; then
      yum install -y ${g_prod_to_pkg[$product]}
    else
      zypper -n --gpg-auto-import-keys in ${g_prod_to_pkg[$product]}
    fi
  else
    local pkg_name=${g_prod_to_pkg[$product]}-${g_version_to_install}
    if ! is_suse ; then
      yum install -y $pkg_name
      yum versionlock add $pkg_name
    else
      zypper -n in -f "$pkg_name"
    fi
  fi
}

function uninstall_deb_pkg() {
  local product="la"
  apt-get purge --autoremove -y ${g_prod_to_pkg[$product]}
}

function uninstall_rpm_pkg() {
  local product="la"
  local pkg_name=${g_prod_to_pkg[$product]}
  if ! is_suse ; then
    yum autoremove -y "$pkg_name"
  else
    zypper -n rm "$pkg_name"
  fi
  set +e
  ! is_suse && yum versionlock delete "$pkg_name"
  set -e
}

function find_installed_products() {
  g_installed_products=()

  for product in "${!g_prod_to_pkg[@]}"; do
    local pkg=${g_prod_to_pkg[$product]}
    if [[ $g_package_type == "deb" ]]; then
      if [[ $(dpkg-query -W -f='${Status}' $pkg 2>&1) == 'install ok installed' ]]; then
        g_installed_products+=("$product")
      fi
    elif [[ $g_package_type == "rpm" ]]; then
      if rpm -q $pkg >/dev/null 2>&1; then
        g_installed_products+=("$product")
      fi
    fi
  done
}

function get_script_update_url() {
  if [[ $g_repo_type == "dev" ]]; then
    echo "https://${g_artifactory_fqdn}/artifactory/SBA_GEN/dev/scripts/install.update"
  elif [[ $g_repo_type == "stg" ]]; then
    echo "https://${g_secureupdates_fqdn}/sbalinux/packages/generic/stg/scripts/install.template"
  elif [[ $g_repo_type == "prod" ]]; then
    echo "https://${g_secureupdates_fqdn}/sbalinux/scripts/install.update"
  fi
}

# schedule or remove cron job for product version update
# this function will schedule or remove the update cronjob based on installed products
function schedule_or_remove_update_cron_job() {
  if [[ $g_should_schedule_upgrade == "no" ]]; then
    return
  fi

  local log_base_path="/var/log/checkpoint/common"
  local log_path="${log_base_path}/sbalinux-update.log"
  local cron_file_path="/etc/cron.d/sbalinux-update"
  local logrotate_base_path="/etc/logrotate.d"
  local logrotate_file_path="${logrotate_base_path}/sbalinux-update"
  local cron_job_update_script="$g_save_folder/update_cronjob.sh"

  find_installed_products

  if ((${#g_installed_products[@]} > 0)); then
    save_self
    mkdir -p $log_base_path
    : >$cron_file_path
    local script_update_url=$(get_script_update_url)

    [[ -z $script_update_url ]] && echo "invalid script update url, cannot setup update cron job" && exit 1
    local script_update_tmp_file="/tmp/sbalinux-install-update.tmp"

    local lock_cmd='[ "${SBA_FLOCKER}" != "$0" ] && exec env SBA_FLOCKER="$0" flock -E 254 -en "/tmp/sbalinux-update-job.lock" "$0" "$@" || :'
    local env_vars_exports="set -o allexport; source $g_env_file; set +o allexport"
    local echo_log_cmd="echo \"--- starting update: \$(date) ---\""

    echo "schedule cronjob"
    if [[ $g_package_type == "deb" ]]; then
      local script_update_cmd="apt-get update; apt-get install -y ${g_installer_package_name}"
    elif is_suse ; then
      local script_update_cmd="zypper -n in ${g_installer_package_name}"
    elif [[ $g_package_type == "rpm" ]]; then
      local script_update_cmd="yum install -y ${g_installer_package_name}"
    fi
    echo "after schedule cronjob"
    local satellite=""
    if [[ -n "$g_force_no_sbalinux_repo" ]] ; then
      satellite="--satellite yes"
    fi

    local product_update_cmd="${g_saved_script} update $satellite"
    if [[ "$g_got_remote_install_product_arg" == 1 ]] ; then
      product_update_cmd+=" --product $g_remote_install_products"
    elif [[ ! -z "$g_update_product" && "$g_update_product" != "$g_default_blades_set" ]] ; then
      product_update_cmd+=" --product $g_update_product"
    fi

    : >$cron_job_update_script
    chmod 744 $cron_job_update_script
    echo '#!/bin/bash' >>$cron_job_update_script
    echo $lock_cmd >>$cron_job_update_script
    echo $env_vars_exports >>$cron_job_update_script
    echo $echo_log_cmd >>$cron_job_update_script
    echo $script_update_cmd >>$cron_job_update_script
    echo $product_update_cmd >>$cron_job_update_script

    echo "$g_update_cron_timing  root  $cron_job_update_script >> ${log_path} 2>&1" >>$cron_file_path

    logrotate_log_file "$logrotate_base_path" "$logrotate_file_path" "$log_path"
  else
    # remove installer package
    set +e
    if [[ $g_package_type == "deb" ]]; then
      apt-get purge -y ${g_installer_package_name}
    elif is_suse ; then
      zypper -n rm ${g_installer_package_name}
    elif [[ $g_package_type == "rpm" ]]; then
      yum autoremove -y ${g_installer_package_name}
    fi
    set -e

    # clean-up any additional cron job related files
    [ "$g_switching_repo" == 0 ] && remove_self
    rm -f $cron_file_path
    rm -f $logrotate_file_path
    rm -f $cron_job_update_script
    rm -f $g_cron_file_switch_repo_path
    set +e
    rm -df $g_save_folder
    set -e
  fi
}

function get_product_from_deb_file() {
  local pkg_filename=$1
  local pkg_name=$(dpkg-deb -f $pkg_filename Package)
  for product in "${!g_prod_to_pkg[@]}"; do
    if [[ $pkg_name == $(g_prod_to_pkg)[$product] ]]; then
      echo $pkg_name
      return 0
    fi
  done
  echo "package file ${pkg_filename} is not valid for installation"
  exit 1
}

function get_product_from_rpm_file() {
  local pkg_filename=$1
  local pkg_name=$(rpm -qp $pkg_filename --queryformat '%{NAME}')
  for product in "${!g_prod_to_pkg[@]}"; do
    if [[ $pkg_name == $(g_prod_to_pkg)[$product] ]]; then
      echo $pkg_name
      return 0
    fi
  done
  echo "package file ${pkg_filename} is not valid for installation"
  exit 1
}

# save copy of this script for invokation from cron jobs
function save_self() {
  mkdir -p $g_save_folder
  if [[ "$0" != $g_saved_script ]]; then
    cp -f "$0" $g_saved_script
    chmod 744 $g_saved_script
  fi
}

# remove the saved copy of this script
function remove_self() {
  if [[ -f $g_saved_script ]]; then
    rm -f $g_saved_script
  fi
}

function do_remote_install() {
  set_repo_type
  set_blades_from_products $g_remote_install_products

  write_env_file
  schedule_install_cron_job $g_args
  store_config_dat_file
  write_ca_cert_and_sig
  if [[ $g_package_type == "deb" ]]; then
    install_prereq_apt
    [[ -z "$g_force_no_sbalinux_repo" ]] && configure_deb_repo $g_repo_type
    install_deb_pkg_from_repo
  elif [[ $g_package_type == "rpm" ]]; then
    if ! is_suse ; then
      install_prereq_yum
    else
      install_prereq_zypper
    fi
    [[ -z "$g_force_no_sbalinux_repo" ]] && configure_rpm_repo $g_repo_type
    install_rpm_pkg_from_repo
  fi

  remove_install_cron_job
  if [ ! -n "$SBA_OFFLINE_PACKAGE" ] ; then
    schedule_or_remove_update_cron_job
  fi
}

function do_file_install() {
  pkg_file=$g_local_install_file_name
  if [[ -f $pkg_file ]]; then
    set_repo_type
    set_blades_from_products $g_remote_install_products
    write_env_file
    schedule_install_cron_job $g_args
    store_config_dat_file
    write_ca_cert_and_sig
    if [[ $g_package_type == "deb" ]]; then
      install_prereq_apt
      [[ -z "$g_force_no_sbalinux_repo" ]] && configure_deb_repo $g_repo_type
      install_deb_pkg_from_file $pkg_file
    elif [[ $g_package_type == "rpm" ]]; then
      if ! is_suse ; then
        install_prereq_yum
      else
        install_prereq_zypper
      fi
      [[ -z "$g_force_no_sbalinux_repo" ]] && configure_rpm_repo $g_repo_type
      install_rpm_pkg_from_file $pkg_file
    fi
    remove_install_cron_job
  else
    echo "cannot find package file ${pkg_file}"
    exit 1
  fi
}

function do_uninstall() {
  set_blades_from_products "$g_uninstall_product"

  echo "deleting all blades dependencies of Linux Agent"
  set +e
  stop_service "cpla"
  if [ "$g_switching_repo" == 0 ]; then
    $g_cpla_path uninstall_all
  else
    $g_cpla_path uninstall_all --skip-notification
  fi
  set -e

  if [[ $g_package_type == "deb" ]]; then
    uninstall_deb_pkg
    [[ -z "$g_force_no_sbalinux_repo" ]] && remove_deb_repo
  elif [[ $g_package_type == "rpm" ]]; then
    uninstall_rpm_pkg
    [[ -z "$g_force_no_sbalinux_repo" ]] && remove_rpm_repo
  fi

  [ -d "$g_offline_repo_path" ] && rm -rf "$g_offline_repo_path"

  schedule_or_remove_update_cron_job

  if [ "$g_switching_repo" == 0 ]; then
    remove_ca_cert_and_sig
    remove_env_file
    remove_leftovers
  fi
}

function check_config_cmd_args() {
  if [[ $num_of_config_args == 0 ]]; then
    echo "Please enter at least one argument to config"
    exit 1
  fi

  # accept base64 encoded key
  if [[ ! $SBA_MANAGEMENT_KEY =~ ^[A-Za-z0-9+/=]*$ ]]; then
    echo "Illegal management server key"
    exit 1
  fi

  if [[ ! -z $SBA_MANAGEMENT_URL && ! $SBA_MANAGEMENT_URL =~ ^https?:\/\/ ]]; then
    echo "Illegal management server url $SBA_MANAGEMENT_URL"
    exit 1
  fi

  if [[ ! -z $HTTP_PROXY && -z $(is_http_url $HTTP_PROXY) && ! $HTTP_PROXY == "none" ]]; then
    echo "Illegal http proxy url"
    exit 1
  fi

  if [[ ! -z $HTTPS_PROXY && -z $(is_http_url $HTTPS_PROXY) && ! $HTTPS_PROXY == "none" ]]; then
    echo "Illegal https proxy url"
    exit 1
  fi
}

# update service environment variable inside systemd service conf file
function update_service_env() {
  local conf_file=$1
  local key=$2
  local value=$3
  if [[ $3 == "none" ]]; then
    value=""
  fi
  sed -i "s|\(\"${key}=\).*\(\"\)|\1${value}\2|" $conf_file
}

# perform config operation
function do_config() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    echo "There is no installed product to config"
    exit 1
  fi

  local product="la"
  echo "Updating configuration for '$product':"
  local conf_file

  conf_file=$g_la_conf_file_path

  if [[ ! -z $SBA_MANAGEMENT_KEY ]]; then
    update_service_env $conf_file "SBA_MANAGEMENT_KEY" "$SBA_MANAGEMENT_KEY"
    update_env_file "SBA_MANAGEMENT_KEY" "$SBA_MANAGEMENT_KEY"
    echo "Updated management server key"
  fi

  if [[ ! -z $SBA_MANAGEMENT_URL ]]; then
    update_service_env $conf_file "SBA_MANAGEMENT_URL" "$SBA_MANAGEMENT_URL"
    update_env_file "SBA_MANAGEMENT_URL" "$SBA_MANAGEMENT_URL"
    echo "Updated management server url"
  fi

  if [[ ! -z $SBA_ENABLE_BG ]]; then
    update_service_env $conf_file "SBA_ENABLE_BG" "$SBA_ENABLE_BG"
    update_env_file "SBA_ENABLE_BG" "$SBA_ENABLE_BG"
    echo "Updated BG status"
  fi

  if [[ ! -z $SBA_CONFIG_DAT_FILE ]]; then
    update_service_env $conf_file "SBA_CONFIG_DAT_FILE" "$SBA_CONFIG_DAT_FILE"
    update_env_file "SBA_CONFIG_DAT_FILE" "$SBA_CONFIG_DAT_FILE"
    echo "Updated config.dat file path"
  fi

  if [[ ! -z $HTTP_PROXY ]]; then
    update_service_env $conf_file "HTTP_PROXY" "$HTTP_PROXY"
    update_service_env $conf_file "http_proxy" "$HTTP_PROXY"
    update_env_file "HTTP_PROXY" "$HTTP_PROXY"
    update_env_file "http_proxy" "$HTTP_PROXY"
    echo "Updated http proxy"
  fi

  if [[ ! -z $HTTPS_PROXY ]]; then
    update_service_env $conf_file "HTTPS_PROXY" "$HTTPS_PROXY"
    update_service_env $conf_file "https_proxy" "$HTTPS_PROXY"
    update_env_file "HTTPS_PROXY" "$HTTPS_PROXY"
    update_env_file "https_proxy" "$HTTPS_PROXY"
    echo "Updated https proxy"
  fi

  if [[ ! -z $NO_PROXY ]]; then
    update_service_env $conf_file "NO_PROXY" "$NO_PROXY"
    update_service_env $conf_file "no_proxy" "$NO_PROXY"
    update_env_file "NO_PROXY" "$NO_PROXY"
    update_env_file "no_proxy" "$NO_PROXY"
    echo "Updated proxy bypass list"
  fi

  if [[ ! -z $SBA_AUTH_PRINCIPAL ]]; then
    update_service_env $conf_file "SBA_AUTH_PRINCIPAL" "$SBA_AUTH_PRINCIPAL"
    update_env_file "SBA_AUTH_PRINCIPAL" "$SBA_AUTH_PRINCIPAL"
    echo "Updated management authentication principal"
  fi

  if [[ ! -z $SBA_USE_DA ]]; then
    update_service_env $conf_file "SBA_USE_DA" "$SBA_USE_DA"
    update_env_file "SBA_USE_DA" "$SBA_USE_DA"
    echo "Updated DA setting"
  fi

  if [[ ! -z $SBA_VDS_LOCATION_GUID ]]; then
    update_service_env $conf_file "SBA_VDS_LOCATION_GUID" "$SBA_VDS_LOCATION_GUID"
    update_env_file "SBA_VDS_LOCATION_GUID" "$SBA_VDS_LOCATION_GUID"
    echo "Updated VDS id"
  fi

  if [[ ! -z $USE_CPCLAM ]]; then
    update_service_env $conf_file "USE_CPCLAM" "$USE_CPCLAM"
    update_env_file "USE_CPCLAM" "$USE_CPCLAM"
    echo "Updated CPCLAM repo"
  fi

  if [[ ! -z $SBA_MITRE ]]; then
    update_service_env $conf_file "SBA_MITRE" "$SBA_MITRE"
    update_env_file "SBA_MITRE" "$SBA_MITRE"
    echo "Updated Mitre flag"
  fi

  if [[ ! -z $SBA_OFFLINE_PACKAGE ]]; then
    update_service_env $conf_file "SBA_OFFLINE_PACKAGE" "$SBA_OFFLINE_PACKAGE"
    update_env_file "SBA_OFFLINE_PACKAGE" "$SBA_OFFLINE_PACKAGE"
    echo "Update LA offline package flag"
  fi

  if [[ ! -z $SBA_PRODUCT_UPDATE_DELAY_MIN ]]; then
    update_service_env $conf_file "SBA_PRODUCT_UPDATE_DELAY_MIN" "$SBA_PRODUCT_UPDATE_DELAY_MIN"
    update_env_file "SBA_PRODUCT_UPDATE_DELAY_MIN" "$SBA_PRODUCT_UPDATE_DELAY_MIN"
    echo "Updated product update delay flag"
  fi

  if [[ ! -z $SBA_DISABLE_TH_ALERTS ]]; then
    update_service_env $conf_file "SBA_DISABLE_TH_ALERTS" "$SBA_DISABLE_TH_ALERTS"
    update_env_file "SBA_DISABLE_TH_ALERTS" "$SBA_DISABLE_TH_ALERTS"
    echo "Updated TH alerts flag"
  fi

  systemctl daemon-reload
}

# placeholder function for a custom action to be performed during update
function update_custom_action() {
  # if env file is missing during update write it according to the current environment
  # this is needed if upgrading from script version <= 0.0.14
  if [[ ! -f $g_env_file ]]; then
    write_env_file
  fi
}

function apt_add_public_signature_key() {
  set_repo_type
  local repo_type="$g_repo_type"
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.public"
  elif [[ $repo_type == "dev"  ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/api/gpg/key/public"
    # add proxy bypass for artifactory
    bypass_proxy ${repo_fqdn}
  else
    echo "invalid repository type"
    exit 1
  fi
  curl -s $key_url | apt-key add -
}

function import_latest_rpm_repo_key() {
  set_repo_type
  local repo_type="$g_repo_type"
  if [[ $repo_type == "prod" || $repo_type == "stg" ]]; then
    local repo_fqdn=$g_secureupdates_fqdn
    local key_url="https://${repo_fqdn}/sbalinux/sbalinux-gpg-key.asc"
  elif [[ $repo_type == "dev" ]]; then
    local repo_fqdn=$g_artifactory_fqdn
    local key_url="https://${repo_fqdn}/artifactory/SBA_GEN/repo_public_keys/rpm/sbalinux-gpg-key.asc"
    # add proxy bypass for artifactory
    bypass_proxy $repo_fqdn
  else
    echo "invalid repository type"
    exit 1
  fi
  is_sysdig_needed && import_sysdig_rpm_key
  rpm --import $key_url
}

function do_update_from_repo() {
  if [[ $g_package_type == "deb" ]]; then
    if [[ ! -f $g_deb_repo_config_file && -z "$g_force_no_sbalinux_repo" ]]; then
      echo "sbalinux debian repository not defined"
      exit 1
    fi
    apt_add_public_signature_key
    update_deb_pkg_from_repo
  elif [[ $g_package_type == "rpm" ]]; then
    if [[ ! -f $g_rpm_repo_config_file && -z "$g_force_no_sbalinux_repo" ]]; then
      echo "sbalinux rpm repository not defined"
      exit 1
    fi
    import_latest_rpm_repo_key
    update_rpm_pkg_from_repo
  fi
  set_cpla_required_products "${g_blades[@]}"
  # do a custom action
  update_custom_action
  # rewrite update cron job cron.d file and script file in case they need to be updated
  schedule_or_remove_update_cron_job
}

function update_deb_pkg_from_repo() {
  local product="la"

  local version_str=""
  if [[ ! -z $g_version_to_install ]]; then
    version_str="=${g_version_to_install}"
  fi

  apt-get update
  apt-get install -y --only-upgrade "${g_prod_to_pkg[$product]}${version_str}"
}

function update_rpm_pkg_from_repo() {
  local product="la"
  echo "update_rpm_pkg_from_repo"
  if is_suse ; then
    zypper -n refresh
    zypper -n up "${g_prod_to_pkg[$product]}"
  else
    if [[ ! -z $g_version_to_install ]]; then
      local pkg_name=${g_prod_to_pkg[$product]}-${g_version_to_install}
      yum install -y $pkg_name
    else
      yum update -y "${g_prod_to_pkg[$product]}"
    fi
  fi
}

function store_config_dat_file() {
  if [[ ! -z $g_da_config_dat_content ]]; then
    mkdir -p $g_da_config_dat_base_path
    echo $g_da_config_dat_content >$g_da_config_dat_file
  fi
}

# write ca cert and sig file from base64 encoded external arguments
function write_ca_cert_and_sig() {
  if [[ ! -z $g_mgmt_ca_cert_data_base64 && ! -z $g_mgmt_ca_cert_sig_data_base64 ]]; then
    mkdir -p $g_ca_cert_base_path
    echo $g_mgmt_ca_cert_data_base64 | base64 --decode >$g_ca_cert_file
    echo $g_mgmt_ca_cert_sig_data_base64 | base64 --decode >$g_ca_cert_sig_file
  fi
}

function remove_ca_cert_and_sig() {
  find_installed_products
  if ((${#g_installed_products[@]} == 0)); then
    rm -f $g_ca_cert_file
    rm -f $g_ca_cert_sig_file
    set +e
    rm -df $g_ca_cert_base_path
    set -e
  fi
}

# when exit code trap occurs, display fail message if exit code > 0
function show_exit_code_trap_error() {
  if (($? > 0)); then
    echo "The $g_operation operation failed! ($(date))"
    if [[ $g_operation == "install" && $g_install_with_cron_job == 'yes' ]]; then
      echo "Another installation attempt was scheduled. It will be started by cron in 30 minutes ($g_cron_file_reinstall_path)"
    fi
  fi
  remove_bootstrap_if_needed
}

# set traps for exit code and ctrl-c to display fail message
function set_trap() {
  trap exit 1 SIGINT
  trap show_exit_code_trap_error EXIT
}

function start_service() {
  local unit_name=$1
  echo "Starting ${unit_name} service"
  systemctl start $unit_name
  # TODO: remove '|| true' after centos_9 installation works
  # without 'Invalid cross-device link' error which doesn't affect cpla service
  systemctl enable $unit_name || true
}

function stop_service() {
  local unit_name=$1
  if systemctl is-active --quiet $unit_name; then
    echo "Stopping ${unit_name} service"
    systemctl stop $unit_name
  fi
  systemctl disable $unit_name
}

function backup_edr_service_conf_file() {
  if [ -e $g_edr_conf_file_path ]; then
    cp $g_edr_conf_file_path $g_products_to_upgrade_conf_dir
  fi
}

function backup_am_service_conf_file() {
  if [ -e $g_am_conf_file_path ]; then
    cp $g_am_conf_file_path $g_products_to_upgrade_conf_dir
  fi
}

function remove_pin_files() {
  local product="$1"
  local deps_pin_file=$(printf "$g_deb_deps_pin_file_template" "$product")
  local pkg_pin_file=$(printf "$g_deb_pkg_pin_file_template" "$product")
  rm -f $deps_pin_file $pkg_pin_file
}

function uninstall_all() {
  # if run uninstall with no arguments, i.e. uninstall all
  local ginstalled
  ginstalled=$(echo "$g_uninstall_product" | xargs)
  local gdefault="${g_default_blades_set},fim"
  if [[ "$ginstalled" == "$gdefault" ]] ; then
    echo "yes"
  else
    echo "no"
  fi
}

function remove_old_products() {
  for pkg in $g_old_products_package_names; do
    if [[ $g_package_type == "deb" ]]; then
      if [[ $(dpkg-query -W -f='${Status}' $pkg 2>&1) == 'install ok installed' ]]; then
        # place service conf in a specific dir so that it can be reused for cpla
        if [[ $pkg == "cpsba-am" ]]; then
          g_products_to_upgrade+=("am")
          backup_am_service_conf_file
          remove_pin_files "am"
        elif [[ $pkg == "cpsba-edr" ]]; then
          g_products_to_upgrade+=("edr")
          backup_edr_service_conf_file
          remove_pin_files "edr"
        fi
        apt-get purge --autoremove -y $pkg || true
      fi
    elif [[ $g_package_type == "rpm" ]]; then
      if rpm -q $pkg >/dev/null 2>&1; then
        # place service conf in a specific dir so that it can be reused for cpla
        if [[ $pkg == "cpsba-am" ]]; then
          g_products_to_upgrade+=("am")
          backup_am_service_conf_file
        elif [[ $pkg == "cpsba-edr" ]]; then
          g_products_to_upgrade+=("edr")
          backup_edr_service_conf_file
        fi
        yum autoremove -y $pkg || true
        yum versionlock delete $pkg || true
      fi
    fi
  done
}

function set_cpla_required_products() {
  echo "Setting cpla blades list"
  local products=("$@")
  local cmdline=""
  for product in ${products[*]}; do
    blade=${g_prod_to_blade[$product]}
    cmdline="$cmdline -b $blade"
  done
  $g_cpla_path set_required_blades $cmdline
}


function migrate_old_products_service_configs() {
  echo "Moving service configuration from old products to cpla"
  if [ "$(ls -A $g_products_to_upgrade_conf_dir)" ]; then
    find $g_products_to_upgrade_conf_dir -name "*.conf" -exec cat {} \; |
      grep -v '\[Service\]' |
      grep -v "^$" |
      awk '{st = index($0, "="); decl = substr($0, st+1); gsub(/"/, "", decl); print decl}' |
      sort |
      uniq \
        >>$g_products_to_upgrade_conf_dir/sbalinux.env
    source $g_products_to_upgrade_conf_dir/sbalinux.env
    do_config
  fi
}

function do_update_deb() {
  if [[ $(dpkg-query -W -f='${Status}' 'cpsba-la' 2>&1) == 'install ok installed' ]]; then
    do_update_from_repo
  else
    install_prereq_apt
    install_deb_pkg_from_repo
    migrate_old_products_service_configs
  fi
}

function do_update_rpm() {
  if rpm -q 'cpsba-la' >/dev/null 2>&1; then
    do_update_from_repo
  else
    [[ -z "$g_force_no_sbalinux_repo" ]] && is_sysdig_needed && import_sysdig_rpm_key
    if ! is_suse ; then
      install_prereq_yum
    else
      install_prereq_zypper
    fi
    install_rpm_pkg_from_repo
    migrate_old_products_service_configs
  fi
}

function do_update() {
  # avoid pined blades in builds < 0.0.463 in order to deliver BG
  # remove me once all customers updated to 0.0.463
  if [[ "$g_update_product" == "edr,am" || "$g_update_product" == "am,edr" ]] ; then
    g_update_product="$g_default_blades_set"
  fi

  set_blades_from_products $g_update_product

  # check audit compatibility in case AM need to be updated,
  # or update to version that at least contains tool to check compatibility
  if [[ "${g_blades[@]}" =~ "am" ]]; then
    local cpla_info_text=$($g_cpla_path info)
    local version=$(echo "$cpla_info_text" | grep -oP 'CPLA version: \K.*')
    if [ -z "$version" ]; then
      version="0.0.0"
    fi

    echo "CPLA version: $version"

    # split version into major, minor and patch
    local major=$(echo $version | cut -d '.' -f 1)
    local minor=$(echo $version | cut -d '.' -f 2)
    local patch=$(echo $version | cut -d '.' -f 3)

    if [ $major -eq 0 ] && [ $minor -eq 0 ] && [ $patch -lt 682 ]; then
      g_version_to_install="0.0.682"
    else
        verify_am_compatibility 0
    fi
  fi

  if [[ $g_package_type == "deb" ]]; then
    do_update_deb
  elif [[ $g_package_type == "rpm" ]]; then
    do_update_rpm
  fi

  if ((${#g_products_to_upgrade[@]} > 0)); then
    set_cpla_required_products "${g_products_to_upgrade[@]}"
  fi

  echo "Installing all blades dependencies of Linux Agent"
  $g_cpla_path install_all
}

function verify_am_compatibility() {
  local need_cleanup=$1
  set +e
  $g_cpla_path check-audit-compat
  local exit_code=$?
  set -e

  # exit code is 1 - fail installation
  if [[ $exit_code -eq 1 ]]; then
    if [[ $need_cleanup -eq 1 ]]; then
      do_uninstall
      remove_install_cron_job
      trap "" EXIT
    fi
    echo "Unable to install Anti Malware. Please contact support."
    exit 1
  fi

  # exit code is 2 - set reboot flag
  if [[ $exit_code -eq 2 ]]; then
    g_need_reboot=1
  fi

  echo "Anti Malware compatibility check completed"
}


if [[ $# -eq 1 && $1 == "--help" ]]; then
  version_str="<developer version>"
  if [[ $SCRIPT_VER =~ ^[0-9]+\.[0-9]+\.[0-9]+$ ]]; then
    version_str="v$SCRIPT_VER"
  fi
  echo "Check Point Sandblast Agent for Linux Installer $version_str"
  echo "Usage: sudo $0 <install|uninstall|config> [options]"
  echo ""
  echo "Possible operations:"
  echo "   install:   install a product"
  echo "   uninstall: uninstall a product"
  echo "   config:    update configuration for an already installed product"
  echo ""
  echo "Options for 'install' operation:"
  echo "  --source <remote|local>             Installation source (default: remote)"
  echo "      remote                          Install from remote package repository"
  echo "      local                           Install from local package file"
  echo "  --product <product>                 Specify product to install, possible products: edr,am (default: both products are installed)"
  echo "                                      Use only if installing from remote package repository"
  echo "  --file_name <file name>             Package file name to install. Use only if installing from local package file"
  echo "  --version <version>                 Product version to install (default: latest). Use only if installing from remote package repository"
  echo "  --url <url>                         Management server url"
  echo "  --key <key>                         Management server key"
  echo "  --http_proxy <url>                  HTTP proxy url"
  echo "  --https_proxy <url>                 HTTPS proxy url"
  echo "  --no_proxy <urls|none|ALL>          bypass proxy for these urls. 'none' leaves the list empty, 'ALL' discards all proxy configuration"
  echo "  --retry <yes|no>                    Schedule another installation attempt if first attempt failed, default: yes"
  echo "  --debug                             Enable debug logging for the client"
  echo "  --selfhealing                       Enable client self-recovery"
  echo "  --auth_principal  <principal>       auth principal which was set up for AD authentication. E.g. krbsvc/sba.com@SBA.COM"
  echo "  --group  <group-guid>               id of virtual directory to put the client into"
  echo ""
  echo "Options for 'uninstall' operation:"
  echo "  --product <product>                 Specify product to uninstall, possible products: edr,am"
  echo ""
  echo "Options for 'config' operation:"
  echo "  --url <url>                         Update management server url"
  echo "  --key <key>                         Update management server key"
  echo "  --http_proxy <url|none>             Update HTTP proxy url. Use 'none' to specify no proxy"
  echo "  --https_proxy <url|none>            Update HTTPS proxy url. Use 'none' to specify no proxy"
  echo "  --no_proxy <urls|none|ALL>          bypass proxy for these urls. Use 'none' for empty list, ',' as delimiter"
  echo "                                      Passing 'ALL' will clear all proxy configuration"
  echo "  --auth_principal  <principal>       auth principal which was set up for AD authentication. E.g. krbsvc/sba.com@SBA.COM"
  echo ""
  exit 0
fi

# exported variable to be used by each product package scripts
# by default pick proxy settings from the environment
export HTTP_PROXY=${HTTP_PROXY:=""}
export HTTPS_PROXY=${HTTPS_PROXY:=""}
export NO_PROXY=${NO_PROXY:=""}
export SBA_MANAGEMENT_KEY=""
export SBA_MANAGEMENT_URL=""
export SBA_CONFIG_DAT_FILE=${SBA_CONFIG_DAT_FILE:=""}
export SBA_ENABLE_BG=${SBA_ENABLE_BG:=""}
export SBA_FORCE_DISTRO=${SBA_FORCE_DISTRO:=""}
export SBA_AUTH_PRINCIPAL=${SBA_AUTH_PRINCIPAL:=""}
export SBA_USE_DA=${SBA_USE_DA:=""}
export SBA_MITRE=${SBA_MITRE:=""}
export USE_CPCLAM=${USE_CPCLAM:=""}
export SBA_VDS_LOCATION_GUID=${SBA_VDS_LOCATION_GUID:=""}
export SBA_OFFLINE_PACKAGE=${SBA_OFFLINE_PACKAGE:=""}
export SBA_PRODUCT_UPDATE_DELAY_MIN=${SBA_PRODUCT_UPDATE_DELAY_MIN:=""}
export SBA_DISABLE_TH_ALERTS=${SBA_DISABLE_TH_ALERTS:=""}


g_package_type=""
g_distro_name=""
g_distro_version=""
g_rpm_repo_config_file=""

# CA cert and signature
g_mgmt_ca_cert_data_base64=""
g_mgmt_ca_cert_sig_data_base64=""
g_ca_cert_base_path="/var/lib/checkpoint/cpmgmt"
g_ca_cert_file="${g_ca_cert_base_path}/server.crt"
g_ca_cert_sig_file="${g_ca_cert_base_path}/server.crt.sig"

# DA config.dat
g_da_config_dat_content=""
g_da_config_dat_base_path="/var/lib/checkpoint/da"
g_da_config_dat_file="${g_da_config_dat_base_path}/config.dat"

g_install_source="remote"
# flag to indicate that products to install from remote repo were given by the user
g_got_remote_install_product_arg=0

if [[ $ARCH == "x86_64" ]]; then
  g_default_blades_set="edr,am,bg"
else
  g_default_blades_set="am"
fi

g_need_reboot=0

g_remote_install_products=${g_default_blades_set}
g_local_install_file_name=""
g_repo_type="prod"
g_uninstall_product="${g_default_blades_set},fim"
g_update_product=${g_default_blades_set}

# products requested to be installed or uninstalled
g_blades=()
# products actually installed
g_installed_products=()
# specific product version to install
g_version_to_install=""

g_update_cron_timing=${SBA_UPDATE_CRON_TIMING:="0 * * * *"}
g_install_cron_timing=${SBA_INSTALL_CRON_TIMING:="*/30 * * * *"}

g_should_schedule_upgrade="yes"
g_install_with_cron_job="yes"
g_cron_file_reinstall_path="/etc/cron.d/sbalinux-install"
g_cron_file_switch_repo_path="/etc/cron.d/sbalinux-product-update"

g_am_conf_file_path="/etc/systemd/system/cpam.service.d/cpam.conf"
g_la_conf_file_path="/etc/systemd/system/cpla.service.d/cpla.conf"
g_edr_conf_file_path="/etc/systemd/system/cpsba.service.d/cpsba.conf"
# for testing: systemctl show --property=Environment <service>

g_args="${@}"

g_epel_rpm_url_template="https://dl.fedoraproject.org/pub/epel/epel-release-latest-%s.noarch.rpm"

g_deb_repo_config_file="/etc/apt/sources.list.d/sbalinux.list"
# preferences file for pinning package dependencies
g_deb_deps_pin_file_template="/etc/apt/preferences.d/sbalinux-%s-deps.pref"
# preferences file for the version of the product itself
g_deb_pkg_pin_file_template="/etc/apt/preferences.d/sbalinux-%s-pkg.pref"

g_secureupdates_fqdn="secureupdates.checkpoint.com"
g_artifactory_fqdn="artifactory-npm.checkpoint.com"

# folder to save helper scripts generated for the update process
g_save_folder="/etc/checkpoint/common"
# path to saved install script used for cron job updates
g_saved_script="${g_save_folder}/install.sh"
# env file path
g_env_file="${g_save_folder}/sbalinux.env"
# package name for installer updates
g_installer_package_name="cpsba-install"
g_cpla_path="/usr/bin/cpla"
# keep g_available_blades_list list space separated.
g_available_blades_list="AM SBA BG FIM"
g_available_products_list="am edr bg fim"
# map of product to its package name
declare -A g_prod_to_pkg
g_prod_to_pkg['la']="cpsba-la"
# map product name to cpla blade name
declare -A g_prod_to_blade
g_prod_to_blade['am']="AM"
g_prod_to_blade['edr']="SBA"
g_prod_to_blade['bg']="BG"
g_prod_to_blade['fim']="FIM"
# old-style packages that have to be removed
g_old_products_package_names="cpsba-edr cpsba-am cpla-install"
g_products_to_upgrade=()
g_products_to_upgrade_conf_dir=$(mktemp -d)
g_force_no_sbalinux_repo=""
# offline_package related variables
g_offline_repo_path="/var/lib/checkpoint/sbalinux_offline"
g_bootstrap_dir=
# leave configs/logs/etc after removal, don't notify mgmt
g_switching_repo=0


# parse args
g_operation=${1:-""}
if [[ -z $g_operation ]]; then
  echo "operation not defined, for usage run: $0 --help"
  exit 1
fi
shift

# apply valid external arguments so they can serve as defaults
apply_embedded_arguments

# parse command line arguments
set +e

if [[ $g_operation == "install" ]]; then
  while (($#)); do
    if [[ $1 == "--http_proxy" ]]; then
      shift
      export HTTP_PROXY=${1:-""}
      export http_proxy=${1:-""}
    elif [[ $1 == "--https_proxy" ]]; then
      shift
      export HTTPS_PROXY=${1:-""}
      export https_proxy=${1:-""}
    elif [[ $1 == "--no_proxy" ]]; then
      shift
      export NO_PROXY=${1:-""}
      export no_proxy=${1:-""}
      if [[ $1 == "ALL" ]]; then
        export HTTP_PROXY=""
        export HTTPS_PROXY=""
        export NO_PROXY=""
        export http_proxy=""
        export https_proxy=""
        export no_proxy=""
      fi
    elif [[ $1 == "--key" ]]; then
      shift
      export SBA_MANAGEMENT_KEY=${1:-""}
    elif [[ $1 == "--url" ]]; then
      shift
      export SBA_MANAGEMENT_URL=${1:-""}
    elif [[ $1 == "--source" ]]; then
      shift
      g_install_source=${1:-""}
    elif [[ $1 == "--product" ]]; then
      shift
      g_remote_install_products=${1:-""}
      g_got_remote_install_product_arg=1
    elif [[ $1 == "--file_name" ]]; then
      shift
      g_local_install_file_name=${1:-""}
    elif [[ $1 == "--version" ]]; then
      shift
      g_version_to_install=${1:-""}
    elif [[ $1 == "--retry" ]]; then
      shift
      g_install_with_cron_job=${1:-""}
    elif [[ $1 == "--debug" ]]; then
      export SBA_LOG_LEVEL=DEBUG
      shift
    elif [[ $1 == "--selfhealing" ]]; then
      export SBA_SELF_HEALING=1
      shift
    elif [[ $1 == "--auth_principal" ]]; then
      shift
      export SBA_AUTH_PRINCIPAL=${1:-""}
    elif [[ $1 == "--group" ]]; then
      shift
      export SBA_VDS_LOCATION_GUID=${1:-""}
    elif [[ $1 == "--upgrade" ]]; then
      shift
      g_should_schedule_upgrade=${1:-""}
    elif [[ $1 == "--stg" ]]; then
      shift
      export SBA_REPO_TYPE=stg
    # Just for the SIPLEC, do not pre-configure sbalinux repo
    elif [[ $1 == "--satellite" ]]; then
      g_force_no_sbalinux_repo=${1:-""}
      shift
    else
      echo "invalid argument $1"
      exit 1
    fi
    shift
  done
elif [[ $g_operation == "config" ]]; then
  num_of_config_args=0
  # dont inherit anything from the environment
  HTTP_PROXY=""
  HTTPS_PROXY=""
  NO_PROXY=""
  SBA_MANAGEMENT_KEY=""
  SBA_MANAGEMENT_URL=""
  SBA_AUTH_PRINCIPAL=""

  while (($#)); do
    if [[ $1 == "--http_proxy" ]]; then
      shift
      export HTTP_PROXY=${1:-""}
    elif [[ $1 == "--https_proxy" ]]; then
      shift
      export HTTPS_PROXY=${1:-""}
    elif [[ $1 == "--no_proxy" ]]; then
      shift
      export NO_PROXY=${1:-""}
      if [[ $1 == "ALL" ]]; then
        export HTTP_PROXY="none"
        export HTTPS_PROXY="none"
        export NO_PROXY="none"
      fi
    elif [[ $1 == "--key" ]]; then
      shift
      export SBA_MANAGEMENT_KEY=${1:-""}
    elif [[ $1 == "--url" ]]; then
      shift
      export SBA_MANAGEMENT_URL=${1:-""}
    elif [[ $1 == "--auth_principal" ]]; then
      shift
      export SBA_AUTH_PRINCIPAL=${1:-""}
    else
      echo "invalid argument $1"
      exit 1
    fi
    [[ -z ${1:-""} ]] && echo "missing value for config option" && exit 1 || let num_of_config_args++
    shift
  done
elif [[ $g_operation == "uninstall" ]]; then
  while (($#)); do
    if [[ $1 == "--product" ]]; then
      shift
      g_uninstall_product=${1:-""}
    elif [[ $1 == "--switching-repo" ]]; then
      shift
      g_switching_repo=1
    else
      echo "invalid argument $1"
      exit 1
    fi
    shift
  done

elif [[ $g_operation == "update" ]]; then
  while (($#)); do
    if [[ $1 == "--product" ]]; then
      shift
      g_update_product=${1:-""}
    elif [[ $1 == "--satellite" ]]; then
      shift
      g_force_no_sbalinux_repo=${1:-""}
    elif [[ $1 == "--version" ]]; then
      shift
      g_version_to_install=${1:-""}
    else
      echo "invalid argument $1. Use update without arguments or with --product <am,edr,bg>"
      exit 1
    fi
    shift
  done
else
  echo "invalid operation '${g_operation}', valid operations are 'install', 'uninstall'"
  exit 1
fi
set -e

# detect distribution and package time
detect_package_type
if [[ -z $g_package_type ]]; then
  echo "Unsupported distribution or architecture"
  exit 1
fi

# main
if [[ $g_operation == "install" ]]; then
  check_offline_package
  check_install_cmd_args
  check_umask
  force_env_vars
  set_trap

  # TODO: remove a few releases after cpla is made the default method of distribution
  remove_old_products

  find_installed_products
  [ -n "$SBA_OFFLINE_PACKAGE" ] && prepare_offline_package
  if ((${#g_installed_products[@]} == 0)); then
    if [[ $g_install_source == "remote" || -n "$SBA_OFFLINE_PACKAGE" ]] ; then
      if [ -n "$SBA_OFFLINE_PACKAGE" ]; then
        echo "Offline install"
      else
        echo "Remote install"
      fi
      do_remote_install
    elif [[ $g_install_source == "local" ]]; then
      echo "Local install"
      do_file_install
    else
      echo "invalid install source mode"
      exit 1
    fi
  else
    echo "cpla is already installed, set of blades will be updated."
    stop_service "cpla"
    set_blades_from_products $g_remote_install_products
  fi

  # check audit compatibility in case AM need to be installed
  if [[ "${g_blades[@]}" =~ "am" ]]; then
    verify_am_compatibility 1
  fi

  set_cpla_required_products "${g_blades[@]}"

  echo "Installing all blades dependencies of Linux Agent"
  $g_cpla_path install_all
  start_service "cpla"

  if [[ $g_need_reboot == 1 ]]; then
    echo "Rebooting the system"
    reboot
  fi


elif [[ $g_operation == "uninstall" ]]; then
  echo "Uninstall all: $(uninstall_all)"
  set_trap
  # TODO: remove a few releases after cpla is made the default method of distribution
  remove_old_products
  set_blades_from_products $g_uninstall_product
  stop_service cpla
  current_blades=$($g_cpla_path get_required_blades)
  echo "Blades installed in cpla: $current_blades"
  for product in ${g_blades[*]}; do
    echo "Deleting ${g_prod_to_blade["$product"]} blade"
    set +e
    $g_cpla_path uninstall_blade -b ${g_prod_to_blade["$product"]}
    set -e
  done
  current_blades=$($g_cpla_path get_required_blades)

  if [ -z "$current_blades" ] || [ "$current_blades" = "Blades: " ] [ "$(uninstall_all)" == "yes" ] ; then
    do_uninstall
  else
    $g_cpla_path install_all
    echo "CPLA still contain installed blades $current_blades"
    start_service cpla
  fi
elif [[ $g_operation == "config" ]]; then
  check_config_cmd_args
  set_trap
  do_config
  echo "Restarting cpla service"
  systemctl restart cpla
elif [[ $g_operation == "update" ]]; then
  set_trap
  remove_old_products
  do_update
  start_service "cpla"
fi

echo $'\n'"The $g_operation operation completed successfully ($(date))"

exit 0
